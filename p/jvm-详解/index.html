<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="认识 JVM">
<title>JVM 详解</title>

<link rel='canonical' href='https://akaxedx.github.io/p/jvm-%E8%AF%A6%E8%A7%A3/'>

<link rel="stylesheet" href="/scss/style.min.ae5dcca4aba68a55efaf26a3449bc5aadef19e44c13385723d3fd76af6f91881.css"><meta property='og:title' content="JVM 详解">
<meta property='og:description' content="认识 JVM">
<meta property='og:url' content='https://akaxedx.github.io/p/jvm-%E8%AF%A6%E8%A7%A3/'>
<meta property='og:site_name' content='AKAxedx-wfj'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='秋招' /><meta property='article:tag' content='笔记' /><meta property='article:published_time' content='2024-09-24T15:59:43&#43;08:00'/><meta property='article:modified_time' content='2024-09-24T15:59:43&#43;08:00'/><meta property='og:image' content='https://akaxedx.github.io/p/jvm-%E8%AF%A6%E8%A7%A3/zoye.jpeg' />
<meta name="twitter:title" content="JVM 详解">
<meta name="twitter:description" content="认识 JVM"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://akaxedx.github.io/p/jvm-%E8%AF%A6%E8%A7%A3/zoye.jpeg' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu6690453460540257700.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">😍</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">AKAxedx-wfj</a></h1>
            <h2 class="site-description">时来天地皆同力，运去英雄不自由</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/akaxedx/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%BD%92%E6%A1%A3/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>深色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#jvm-内存管理">JVM 内存管理</a>
      <ol>
        <li><a href="#内存区域划分">内存区域划分</a>
          <ol>
            <li><a href="#大致划分">大致划分</a></li>
            <li><a href="#爆内存和爆栈">爆内存和爆栈</a></li>
            <li><a href="#申请堆外内存">申请堆外内存</a></li>
          </ol>
        </li>
        <li><a href="#垃圾回收机制">垃圾回收机制</a>
          <ol>
            <li><a href="#对象存活判定算法">对象存活判定算法</a></li>
            <li><a href="#垃圾回收算法">垃圾回收算法</a></li>
            <li><a href="#垃圾收集器实现">垃圾收集器实现</a></li>
            <li><a href="#元空间">元空间</a></li>
            <li><a href="#其他区引用类型">其他区引用类型</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#类与类加载">类与类加载</a>
      <ol>
        <li><a href="#类文件结构">类文件结构</a>
          <ol>
            <li><a href="#类文件信息">类文件信息</a></li>
            <li><a href="#字节码指令">字节码指令</a></li>
            <li><a href="#asm-字节码编程">ASM 字节码编程</a></li>
          </ol>
        </li>
        <li><a href="#类加载机制">类加载机制</a>
          <ol>
            <li><a href="#类加载过程">类加载过程</a></li>
          </ol>
        </li>
        <li><a href="#类加载器">类加载器</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/jvm-%E8%AF%A6%E8%A7%A3/">
                <img src="/p/jvm-%E8%AF%A6%E8%A7%A3/zoye_hu1336375723416804286.jpeg"
                        srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/zoye_hu1336375723416804286.jpeg 800w, /p/jvm-%E8%AF%A6%E8%A7%A3/zoye_hu6691682046714376575.jpeg 1600w"
                        width="800" 
                        height="800" 
                        loading="lazy"
                        alt="Featured image of post JVM 详解" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/jvm-%E8%AF%A6%E8%A7%A3/">JVM 详解</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            认识 JVM
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-09-24</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="jvm-详解">JVM 详解
</h1><h2 id="jvm-内存管理">JVM 内存管理
</h2><p>在之前，我们了解了 JVM 的大致运作原理以及相关特性，这一章，我们首先会从内存管理说起。</p>
<p>在传统的 C/C++ 开发中，我们经常通过使用申请内存的方式来创建对象或是存放某些数据，但是这样也带来了一些额外的问题，我们要在何时释放这些内存，怎么才能使得内存的使用最高效，因此，内存管理是一个非常严肃的问题。</p>
<p>比如我们就可以通过 C 语言动态申请内存，并用于存放数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//动态申请4个int大小的内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span><span class="o">*</span> <span class="n">memory</span> <span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//修改第一个int空间的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//修改第二个int空间的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memory</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//遍历内存区域中所有的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">memory</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//释放指针所指向的内存区域
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">free</span><span class="p">(</span><span class="n">memory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//最后将指针赋值为NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">memory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而在 Java 中，这种操作实际上是不允许的，Java 只支持直接使用基本数据类型和对象类型，至于内存到底如何分配，并不是由我们来处理，而是 JVM 帮助我们进行控制，这样就帮助我们节省很多内存上的工作，虽然带来了很大的便利，但是，一旦出现内存问题，我们就无法像 C/C++ 那样对所管理的内存进行合理地处理，因为所有的内存操作都是由 JVM 在进行，只有了解了 JVM 的内存管理机制，我们才能够在出现内存相关问题时找到解决方案。</p>
<h3 id="内存区域划分">内存区域划分
</h3><p>既然要管理内存，那么肯定不会是杂乱无章的，JVM 对内存的管理采用的是分区治理，不同的内存区域有着各自的职责所在，在虚拟机运行时，内存区域如下划分：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924161318393.png"
	width="831"
	height="579"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924161318393_hu3537698930462532554.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924161318393_hu10447957083745082773.png 1024w"
	loading="lazy"
	
		alt="经典JVM内存分区图"
	
	
		class="gallery-image" 
		data-flex-grow="143"
		data-flex-basis="344px"
	
></p>
<p>我们可以看到，内存区域一共分为5个区域，其中方法区和堆是所有线程共享的区域，随着虚拟机的创建而创建，虚拟机的结束而销毁，而虚拟机栈、本地方法栈、程序计数器都是线程之间相互隔离的，每个线程都有一个自己的区域，并且线程启动时会自动创建，结束之后会自动销毁。内存划分完成之后，我们的 JVM 执行引擎和本地库接口，也就是 Java 程序开始运行之后就会根据分区合理地使用对应区域的内存了。</p>
<h4 id="大致划分">大致划分
</h4><h5 id="程序计数器">程序计数器
</h5><p>首先我们来介绍一下程序计数器，它和我们的传统 8086 CPU 中 PC 寄存器的工作差不多，因为 JVM 虚拟机目的就是实现物理机那样的程序执行。在 8086 CPU 中，PC 作为程序计数器，负责储存内存地址，该地址指向下一条即将执行的指令，每解释执行完一条指令，PC 寄存器的值就会自动被更新为下一条指令的地址，进入下一个指令周期时，就会根据当前地址所指向的指令，进行执行。</p>
<p>而 JVM 中的程序计数器可以看做是当前线程所执行字节码的行号指示器，而行号正好就指的是某一条指令，字节码解释器在工作时也会改变这个值，来指定下一条即将执行的指令。</p>
<p>因为 Java 的多线程也是依靠时间片轮转算法进行的，因此一个 CPU 同一时间也只会处理一个线程，当某个线程的时间片消耗完成后，会自动切换到下一个线程继续执行，而当前线程的执行位置会被保存到当前线程的程序计数器中，当下次轮转到此线程时，又继续根据之前的执行位置继续向下执行。</p>
<p>程序计数器因为只需要记录很少的信息，所以只占用很少一部分内存。</p>
<h5 id="虚拟机栈">虚拟机栈
</h5><p>虚拟机栈就是一个非常关键的部分，看名字就知道它是一个栈结构，每个方法被执行的时候，Java 虚拟机都会同步创建一个栈帧(其实就是栈里面的一个元素)，栈帧中包括了当前方法的一些信息，比如局部变量表、操作数栈、动态链接、方法出口等。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924181223721.png"
	width="1071"
	height="565"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924181223721_hu12581360635472026255.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924181223721_hu8779909252128880682.png 1024w"
	loading="lazy"
	
		alt="虚拟机栈"
	
	
		class="gallery-image" 
		data-flex-grow="189"
		data-flex-basis="454px"
	
></p>
<p>其中局部变量表就是我们方法中的局部变量，之前我们也进行过演示，实际上局部变量表在class文件中就已经定义好了，操作数栈就是我们之前字节码执行时使用到的栈结构；每个栈帧还保存了一个可以指向当前方法所在类的运行时常量池、目的是：当前方法中如果需要调用其他方法的时候，能够从运行时常量池中找到对应的符号引用，然后将符号引用转换为直接引用，然后就能直接调用对应方法，这就是动态链接（我们还没讲到常量池，暂时记住即可，建议之后再回顾一下），最后是方法出口，也就是方法该如何结束,是抛出异常还是正常返回。</p>
<p>可能听起来有点懵逼，这里我们来模拟一下整个虚拟机栈的运作流程，我们先编写一个测试类:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">res</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">a</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">b</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">b</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">c</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">20</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当我们的主方法执行后，会依次执行三个方法a() -&gt; b() -&gt; c() -&gt;返回 ，我们首先来观察一下反编译之后的结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">Main</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="p">()</span><span class="n">V</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="p">:</span> <span class="n">ACC_PUBLIC</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">aload_0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">1</span><span class="p">:</span> <span class="n">invokespecial</span> <span class="c1">#1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">         <span class="mi">4</span><span class="p">:</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="n">LineNumberTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">      <span class="n">LocalVariableTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
</span></span><span class="line"><span class="cl">            <span class="mi">0</span>       <span class="mi">5</span>     <span class="mi">0</span>  <span class="n">this</span>   <span class="n">LMain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="k">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">String</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="p">([</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="ne">String</span><span class="p">;)</span><span class="n">V</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="p">:</span> <span class="n">ACC_PUBLIC</span><span class="p">,</span> <span class="n">ACC_STATIC</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">invokestatic</span>  <span class="c1">#7                  // Method a:()I</span>
</span></span><span class="line"><span class="cl">         <span class="mi">3</span><span class="p">:</span> <span class="n">istore_1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">4</span><span class="p">:</span> <span class="n">getstatic</span>     <span class="c1">#13                 // Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span></span><span class="line"><span class="cl">         <span class="mi">7</span><span class="p">:</span> <span class="n">iload_1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">8</span><span class="p">:</span> <span class="n">invokevirtual</span> <span class="c1">#19                 // Method java/io/PrintStream.println:(I)V</span>
</span></span><span class="line"><span class="cl">        <span class="mi">11</span><span class="p">:</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="n">LineNumberTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">11</span>
</span></span><span class="line"><span class="cl">      <span class="n">LocalVariableTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
</span></span><span class="line"><span class="cl">            <span class="mi">0</span>      <span class="mi">12</span>     <span class="mi">0</span>  <span class="n">args</span>   <span class="p">[</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="ne">String</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="mi">4</span>       <span class="mi">8</span>     <span class="mi">1</span>   <span class="n">res</span>   <span class="n">I</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="k">static</span> <span class="ne">int</span> <span class="n">a</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="p">()</span><span class="n">I</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="p">:</span> <span class="n">ACC_PUBLIC</span><span class="p">,</span> <span class="n">ACC_STATIC</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">invokestatic</span>  <span class="c1">#25                 // Method b:()I</span>
</span></span><span class="line"><span class="cl">         <span class="mi">3</span><span class="p">:</span> <span class="n">ireturn</span>
</span></span><span class="line"><span class="cl">      <span class="n">LineNumberTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="k">static</span> <span class="ne">int</span> <span class="n">b</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="p">()</span><span class="n">I</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="p">:</span> <span class="n">ACC_PUBLIC</span><span class="p">,</span> <span class="n">ACC_STATIC</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">invokestatic</span>  <span class="c1">#28                 // Method c:()I</span>
</span></span><span class="line"><span class="cl">         <span class="mi">3</span><span class="p">:</span> <span class="n">ireturn</span>
</span></span><span class="line"><span class="cl">      <span class="n">LineNumberTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="k">static</span> <span class="ne">int</span> <span class="n">c</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="p">()</span><span class="n">I</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="p">:</span> <span class="n">ACC_PUBLIC</span><span class="p">,</span> <span class="n">ACC_STATIC</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">bipush</span>        <span class="mi">10</span>
</span></span><span class="line"><span class="cl">         <span class="mi">2</span><span class="p">:</span> <span class="n">istore_0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">3</span><span class="p">:</span> <span class="n">bipush</span>        <span class="mi">20</span>
</span></span><span class="line"><span class="cl">         <span class="mi">5</span><span class="p">:</span> <span class="n">istore_1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">6</span><span class="p">:</span> <span class="n">iload_0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">7</span><span class="p">:</span> <span class="n">iload_1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">8</span><span class="p">:</span> <span class="n">iadd</span>
</span></span><span class="line"><span class="cl">         <span class="mi">9</span><span class="p">:</span> <span class="n">ireturn</span>
</span></span><span class="line"><span class="cl">      <span class="n">LineNumberTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">14</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">15</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">16</span><span class="p">:</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">      <span class="n">LocalVariableTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
</span></span><span class="line"><span class="cl">            <span class="mi">3</span>       <span class="mi">7</span>     <span class="mi">0</span>     <span class="n">a</span>   <span class="n">I</span>
</span></span><span class="line"><span class="cl">            <span class="mi">6</span>       <span class="mi">4</span>     <span class="mi">1</span>     <span class="n">b</span>   <span class="n">I</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到在编译之后，我们整个方法的最大操作数栈深度、局部变量表都是已经确定好的，当我们程序开始执行时，会根据这些信息封装为对应的栈帧，我们从 main 方法开始看起：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182518764.png"
	width="1078"
	height="556"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182518764_hu12550865975381259332.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182518764_hu7179782587594150357.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="193"
		data-flex-basis="465px"
	
></p>
<p>接着我们继续往下，到了0: invokestatic	#7		// Method a:()I 时，需要调用方法 a()，这时当前方法就不会继续向下运行了，而是去执行方法 a() ，那么同样的，将此方法也入栈，注意是放入到栈顶位置， main 方法的栈帧会被压下去:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182713356.png"
	width="1084"
	height="559"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182713356_hu14809201731811238867.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182713356_hu7978553790971499603.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="193"
		data-flex-basis="465px"
	
></p>
<p>这时，进入方法a之后，又继而进入到方法b，最后在进入c，因此，到达方法c的时候，我们的虚拟机栈变成了：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182743025.png"
	width="1051"
	height="506"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182743025_hu6714897938282508594.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182743025_hu3677453610059124113.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="207"
		data-flex-basis="498px"
	
></p>
<p>现在我们依次执行方法 c 中的指令，最后返回 a+b 的结果，在方法 c 返回之后，也就代表方法 c 已经执行结束了，栈帧 4会自动出栈，这时栈帧 3 就得到了上一栈帧返回的结果，并继续执行，但是由于紧接着马上就返回，所以继续重复栈帧 4 的操作，此时栈帧 3 也出栈并继续将结果交给下一个栈帧 2 ，最后栈帧 2 再将结果返回给栈帧 1，然后栈帧 1 就可以继续向下运行了，最后输出结果。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182959539.png"
	width="1079"
	height="594"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182959539_hu2459715052462392517.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924182959539_hu13355804177699292864.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="181"
		data-flex-basis="435px"
	
></p>
<h5 id="本地方法栈">本地方法栈
</h5><p>本地方法栈与虚拟机栈作用差不多，但是它是为本地方法准备的，这里不多做介绍。</p>
<h5 id="堆">堆
</h5><p>堆是整个 Java 应用程序共享的区域，也是整个虚拟机最大的一块内存空间，而此区域的职责就是存放和管理对象和数组，而我们马上要提到的垃圾回收机制也是主要作用于这一部分内存区域。</p>
<h5 id="方法区">方法区
</h5><p>方法区也是整个 Java 应用程序共享的区域，它用于存储所有的类信息、常量、静态变量、动态编译缓存等数据，可以大致分为两个部分，一个是类信息表，一个是运行时常量池。方法区也是我们要重点介绍的部分。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183128748.png"
	width="1080"
	height="588"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183128748_hu7092298949313758737.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183128748_hu13286815185902149180.png 1024w"
	loading="lazy"
	
		alt="方法区"
	
	
		class="gallery-image" 
		data-flex-grow="183"
		data-flex-basis="440px"
	
></p>
<p>首先类信息表中存放的是当前应用程序加载的所有类信息，包括类的版本、字段、方法、接口等信息，同时会将编译时生成的常量池数据全部存放到运行时常量池中。当然，常量也并不是只能从类信息中获取，在程序运行时，也有可能会有新的常量进入到常量池。</p>
<p>其实我们的 String 类正是利用了常量池进行优化，这里我们编写一个测试用例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">Stringl</span><span class="o">]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="o">==</span><span class="w"> </span><span class="n">str2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">str2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>得到的结果也是显而易见的，由于 str1 和 str2 是单独创建的两个对象，那么这两个对象实际上会在堆中存放，保存在不同的地址：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183523543.png"
	width="1079"
	height="450"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183523543_hu14413188531304644670.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183523543_hu3848283183037858725.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="239"
		data-flex-basis="575px"
	
></p>
<p>所以当我们使用 == 判断时，得到的结果 false，而使用 equals 时因为比较的是值，所以得到 true 。现在我们来稍微修改一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;abc&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;abc&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="o">==</span><span class="w"> </span><span class="n">str2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">str2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>现在我们没有使用 new 的形式，而是直接使用双引号创建，那么这时得到的结果就变成了两个 true，这是为什么呢？这其实是因为我们直接使用双引号赋值，会先在常量池中查找是否存在相同的字符串，若存在，则将引用直接指向该字符串;若不存在，则在常量池中生成一个字符串，再将引用指向该字符串:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Constant pool:
</span></span><span class="line"><span class="cl">   #1 = Methodref          #2.#3          // java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">   #2 = Class              #4             // java/lang/Object
</span></span><span class="line"><span class="cl">   #3 = NameAndType        #5:#6          // &#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">   #4 = Utf8               java/lang/Object
</span></span><span class="line"><span class="cl">   #5 = Utf8               &lt;init&gt;
</span></span><span class="line"><span class="cl">   #6 = Utf8               ()V
</span></span><span class="line"><span class="cl">   #7 = String             #8             // abc
</span></span><span class="line"><span class="cl">   #8 = Utf8               abc
</span></span><span class="line"><span class="cl">   #9 = Fieldref           #10.#11        // java/lang/System.out:Ljava/io/PrintStream;
</span></span><span class="line"><span class="cl">  #10 = Class              #12            // java/lang/System
</span></span><span class="line"><span class="cl">  #11 = NameAndType        #13:#14        // out:Ljava/io/PrintStream;
</span></span><span class="line"><span class="cl">  #12 = Utf8               java/lang/System
</span></span><span class="line"><span class="cl">  #13 = Utf8               out
</span></span><span class="line"><span class="cl">  #14 = Utf8               Ljava/io/PrintStream;
</span></span><span class="line"><span class="cl">  #15 = Methodref          #16.#17        // java/io/PrintStream.println:(Z)V
</span></span><span class="line"><span class="cl">  #16 = Class              #18            // java/io/PrintStream
</span></span><span class="line"><span class="cl">  #17 = NameAndType        #19:#20        // println:(Z)V
</span></span><span class="line"><span class="cl">  #18 = Utf8               java/io/PrintStream
</span></span><span class="line"><span class="cl">  #19 = Utf8               println
</span></span><span class="line"><span class="cl">  #20 = Utf8               (Z)V
</span></span><span class="line"><span class="cl">  #21 = Methodref          #22.#23        // java/lang/String.equals:(Ljava/lang/Object;)Z
</span></span><span class="line"><span class="cl">  #22 = Class              #24            // java/lang/String
</span></span><span class="line"><span class="cl">  #23 = NameAndType        #25:#26        // equals:(Ljava/lang/Object;)Z
</span></span><span class="line"><span class="cl">  #24 = Utf8               java/lang/String
</span></span><span class="line"><span class="cl">  #25 = Utf8               equals
</span></span><span class="line"><span class="cl">  #26 = Utf8               (Ljava/lang/Object;)Z
</span></span><span class="line"><span class="cl">  #27 = Class              #28            // Main
</span></span><span class="line"><span class="cl">  #28 = Utf8               Main
</span></span><span class="line"><span class="cl">  #29 = Utf8               Code
</span></span><span class="line"><span class="cl">  #30 = Utf8               LineNumberTable
</span></span><span class="line"><span class="cl">  #31 = Utf8               LocalVariableTable
</span></span><span class="line"><span class="cl">  #32 = Utf8               this
</span></span><span class="line"><span class="cl">  #33 = Utf8               LMain;
</span></span><span class="line"><span class="cl">  #34 = Utf8               main
</span></span><span class="line"><span class="cl">  #35 = Utf8               ([Ljava/lang/String;)V
</span></span><span class="line"><span class="cl">  #36 = Utf8               args
</span></span><span class="line"><span class="cl">  #37 = Utf8               [Ljava/lang/String;
</span></span><span class="line"><span class="cl">  #38 = Utf8               str1
</span></span><span class="line"><span class="cl">  #39 = Utf8               Ljava/lang/String;
</span></span><span class="line"><span class="cl">  #40 = Utf8               str2
</span></span><span class="line"><span class="cl">  #41 = Utf8               StackMapTable
</span></span><span class="line"><span class="cl">  #42 = Class              #37            // &#34;[Ljava/lang/String;&#34;
</span></span><span class="line"><span class="cl">  #43 = Utf8               SourceFile
</span></span><span class="line"><span class="cl">  #44 = Utf8               Main.java
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183859531.png"
	width="584"
	height="68"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183859531_hu16344923782421556801.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924183859531_hu5428710396798698319.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="858"
		data-flex-basis="2061px"
	
></p>
<p>被丢进了常量池</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924184156534.png"
	width="1076"
	height="466"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924184156534_hu7730118925700086864.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924184156534_hu9760954740561369626.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="230"
		data-flex-basis="554px"
	
></p>
<p>实际上两次调用Sting类的<code> intern()</code>方法，和上面的效果差不多，也是第一次调用会将堆中字符串复制并放入常量池中，第二次通过此方法获取字符串时，会查看常量池中是否包含，如果包含那么会直接返回常量池中字符串的地址：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//不能直接写&#34;abc&#34;，双引号的形式，写了就直接在常量池里面吧abc创好了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;ab&#34;</span><span class="p">)</span><span class="o">+</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;ab&#34;</span><span class="p">)</span><span class="o">+</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="na">inern</span><span class="p">()</span><span class="o">==</span><span class="w"> </span><span class="n">str2</span><span class="p">.</span><span class="na">intern</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">str2</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924201211480.png"
	width="1070"
	height="439"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924201211480_hu13183097595952459652.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924201211480_hu2445599826479129981.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="243"
		data-flex-basis="584px"
	
></p>
<p>所以上述结果中得到的依然是两个 true 。在JDK1.7之后，稍微有一些区别，在调用 intern()方法时，当常量池中没有对应的字符串时，不会再进行复制操作，而是将其直接修改为指向当前字符串堆中的的引用：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924201615228.png"
	width="1067"
	height="364"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924201615228_hu14095422564491259629.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924201615228_hu11926391309034197508.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="293"
		data-flex-basis="703px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 不能直接写 &#34;abc&#34;，双引号的形式，写了就直接再常量池里面把 abc 创好了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;ab&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="na">intern</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">str1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;ab&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">str2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;ab&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str1</span><span class="p">.</span><span class="na">intern</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">str1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">str2</span><span class="p">.</span><span class="na">intern</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">str1</span><span class="p">);</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>所以最后我们会发现，str1.intern()和 str1 都是同一个对象，结果为 true 。</p>
<p>值得注意的是，在 JDK7 之后，字符串常量池从方法区移动到了堆中。</p>
<p>最后我们再来进行一个总结，各个内存区域的用途：</p>
<ul>
<li>（线程独有）程序计数器：保存当程序的执行位置</li>
<li>（线程独有）虚拟机栈：通过栈帧来维持方法调用顺序，帮助控制程序有序运行</li>
<li>（线程独有）本地方法栈：同上，作用于本地方法</li>
<li>堆：所有的对象和数组都在这里保存</li>
<li>方法区：类信息、即时编译器的代码缓存、运行时常量池。</li>
</ul>
<p>当然，这些内存区域划分仅仅是概念上的，具体的实现过程我们后面还会提到</p>
<h4 id="爆内存和爆栈">爆内存和爆栈
</h4><p>实际上，在java程序运行时，内存容量不可能是无限制的，当我们的对象创建过多或是数组容量过大时，就会导致我们的堆内存不足以存放更多新的对象或是数组，这时就会出现错误，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">stringLl</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们申请了一个容量为21亿多的int型数组，显然，如此之大的数组不可能放在我们的堆内存中，所以程序运行时就会这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Exception in thread <span class="s2">&#34;main&#34;</span> java.lang.0utOfMemoryError: Requested array size exceeds VM limit
</span></span><span class="line"><span class="cl">at com.test.Main.main<span class="o">(</span>Main.java:5<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里得到了一个 0ut0fMemoryError 错误，也就是我们常说的内存溢出错误。我们可以通过参数来控制堆内存的最大值和最小值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">-Xms最小值 -Xmx最大值
</span></span></code></pre></td></tr></table>
</div>
</div><p>比如我们现在限制堆内存为固定值 1M 大小，并且在抛出内存溢出异常时保存当前的内存堆转储快照：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924202925460.png"
	width="369"
	height="24"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924202925460_hu7068610415874314103.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924202925460_hu12032719563988358065.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1537"
		data-flex-basis="3690px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在程序运行之后：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">OutOfMemoryError</span><span class="p">:</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Dumping</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">java_pid19916</span><span class="p">.</span><span class="na">hprof</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Heap</span><span class="w"> </span><span class="n">dump</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="o">[</span><span class="n">13463121</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">0</span><span class="p">.</span><span class="na">029</span><span class="w"> </span><span class="n">secs</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Exception</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="s">&#34;main&#34;</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">OutOfMemoryError</span><span class="p">:</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">space</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Arrays</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">3210</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">Arrays</span><span class="p">.</span><span class="na">copyOf</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">3181</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">ArrayList</span><span class="p">.</span><span class="na">grow</span><span class="p">(</span><span class="n">ArrayList</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">267</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">ArrayList</span><span class="p">.</span><span class="na">ensureExplicitCapacity</span><span class="p">(</span><span class="n">ArrayList</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">241</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">ArrayList</span><span class="p">.</span><span class="na">ensureCapacityInternal</span><span class="p">(</span><span class="n">ArrayList</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">233</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">ArrayList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ArrayList</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">464</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main</span><span class="p">.</span><span class="na">main</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">11</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到错误出现原因正是 Java heap space，也就是堆内存满了，并且根据我们设定的 VM 参数，堆内存保存了快照信息。我们可以在 IDEA 内置的 Profiler 中进行查看:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924205213049.png"
	width="1913"
	height="416"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924205213049_hu1848042632492737413.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924205213049_hu16209557320856330703.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="459"
		data-flex-basis="1103px"
	
></p>
<p>可以很明显地看到，在创建了 360146 个 Test 对象之后，堆内存蚌住了，于是就抛出了内存溢出错误。</p>
<p>我们接着来看栈溢出，我们知道，虚拟机栈会在方法调用时插入栈帧，那么，设想如果出现无限递归的情况呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">test</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">test</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这很明显是一个永无休止的程序，并且会不断继续向下调用 test() 方法本身，那么按照我们之前的逻辑推导，无限地插入栈帧，一定会将虚拟机栈塞满，所以，当栈的深度已经不足以插入栈帧时，就会这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Exception</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="s">&#34;main&#34;</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">StackOverflowError</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main</span><span class="p">.</span><span class="na">test</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">13</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main</span><span class="p">.</span><span class="na">test</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">13</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main</span><span class="p">.</span><span class="na">test</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">13</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main</span><span class="p">.</span><span class="na">test</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">13</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main</span><span class="p">.</span><span class="na">test</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">13</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">......</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这也是我们常说的栈溢出，它和堆溢出比较类似，也是由于容纳不下才导致的，我们可以使用 -Xss 来设定栈容量。</p>
<h4 id="申请堆外内存">申请堆外内存
</h4><p>除了堆内存可以存放对象数据以外，我们也可以申请堆外内存(直接内存)，也就是不受 JVM 管控的内存区域，这部分区域的内存需要我们自行去申请和释放，实际上本质就是 JVM 通过 C/C++ 调用  malloc 函数申请的内存，当然得我们自己去释放了。不过虽然是直接内存，不会受到堆内存容量限制，但是依然会受到本机最大内存的限制，所以还是有可能抛出 0ut0fMemoryError 异常。
这里我们需要提到一个堆外内存操作类：Unsafe，就像它的名字一样，虽然 Java 提供堆外内存的操作类，但是实际上它是不安全的，只有你完全了解底层原理并且能够合理控制堆外内存，才能安全地使用堆外内存</p>
<p>注意这个类不让我们new，也没有直接获取方式（压根就没想让我们用）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">registerNatives</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">registerNatives</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sun</span><span class="p">.</span><span class="na">reflect</span><span class="p">.</span><span class="na">Reflection</span><span class="p">.</span><span class="na">registerMethodsToFilter</span><span class="p">(</span><span class="n">Unsafe</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;getUnsafe&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">Unsafe</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">theUnsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Unsafe</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@CallerSensitive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Unsafe</span><span class="w"> </span><span class="nf">getUnsafe</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">caller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reflection</span><span class="p">.</span><span class="na">getCallerClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">VM</span><span class="p">.</span><span class="na">isSystemDomainLoader</span><span class="p">(</span><span class="n">caller</span><span class="p">.</span><span class="na">getClassLoader</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecurityException</span><span class="p">(</span><span class="s">&#34;Unsafe&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 不是 JDK 的类，不让用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">theUnsafe</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>所以这里通过反射搞出来</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Unsafe</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="w"> </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>成功拿到 Unsafe 类之后，我们就可以开始申请堆外内存了，比如我们现在想要申请一个 int 大小的内存空间，并在此空间中存放一个 int 类型的数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Field</span><span class="w"> </span><span class="n">unsafeField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Unsafe</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Unsafe</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Unsafe</span><span class="p">)</span><span class="w"> </span><span class="n">unsafeField</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//申请4字节大小的内存空间，并得到对应位置的地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsafe</span><span class="p">.</span><span class="na">allocateMemory</span><span class="p">(</span><span class="n">4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//在对应的地址上设定int的值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unsafe</span><span class="p">.</span><span class="na">putInt</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">6666666</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//获取对应地址上的Int型数值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="n">address</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//释放申请到的内容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">unsafe</span><span class="p">.</span><span class="na">freeMemory</span><span class="p">(</span><span class="n">address</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//由于内存已经释放，这时数据就没了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="na">getInt</span><span class="p">(</span><span class="n">address</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>遗憾的是，这里可能由于 JDK 版本的问题，第二次依然可能拿到 6666666 的值</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924212322954.png"
	width="161"
	height="62"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924212322954_hu12982333636715002284.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924212322954_hu15936389885879090657.png 1024w"
	loading="lazy"
	
		alt="理想情况"
	
	
		class="gallery-image" 
		data-flex-grow="259"
		data-flex-basis="623px"
	
></p>
<p>我们可以来看一下 allocateMemory 底层是如何调用的，这是一个 native方法，我们来看 C++ 源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">UNSAFE_ENTRY</span><span class="p">(</span><span class="n">jlong</span><span class="p">,</span><span class="n">Unsafe_AllocateMemory0</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">unsafe</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">size</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">sz</span><span class="o">=</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sz</span><span class="o">=</span> <span class="n">align_up</span><span class="p">(</span><span class="n">sz</span><span class="err">，</span><span class="n">HeapWordSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span><span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">mtOther</span><span class="p">);</span><span class="c1">//这里调用了os::malloc方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nf">addr_to_java</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">UNSAFE_END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着来看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">os</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">size_t</span> <span class="n">size</span><span class="err">，</span><span class="n">MEMFLAGS</span> <span class="n">flags</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">flags</span><span class="p">,</span><span class="n">CALLER_PC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">os</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">MEMFLAGS</span> <span class="n">memflags</span><span class="p">,</span> <span class="k">const</span> <span class="n">NativeCallStack</span><span class="o">&amp;</span> <span class="n">stack</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="n">u_char</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ptr</span> <span class="o">=</span><span class="p">(</span><span class="n">u_char</span><span class="o">*</span><span class="p">)</span><span class="o">::</span><span class="n">mallgc</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">);</span><span class="c1">//调用C++标准库函数 malloc(size)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// we do not track guard memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="n">MemTracker</span><span class="o">::</span><span class="n">record_malloc</span><span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">memflags</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以，我们上面的 Java 代码转换为 C 代码，差不多就是这个意思：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span><span class="o">*</span> <span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="mi">6666666</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以说，直接内存实际上就是 JVM 申请的一块额外的内存空间，但是它并不在受管控的几种内存空间中，当然这些内存依然属于是 JVM 的，由于 JVM 提供的堆内存会进行垃圾回收等工作，效率不如直接申请和操作内存来得快，一些比较追求极致性能的框架会用到堆外内存来提升运行速度，如 nio 框架。</p>
<h3 id="垃圾回收机制">垃圾回收机制
</h3><p>**注意：**此部分为重点内容</p>
<p>我们前面提到，Java 会自动管理和释放内存，它不像 C/C++ 那样要求我们手动管理内存，JVM 提供了一套全自动的内存管理机制，当一个 Java 对象不再用到时，JVM 会自动将其进行回收并释放内存，那么对象所占内存在什么时候被回收，如何判定对象可以被回收，以及如何去进行回收工作也是 JVM 需要关注的问题。</p>
<h4 id="对象存活判定算法">对象存活判定算法
</h4><p>首先我们来套讨论第一个问题，也就是：对象在什么情况下可以被判定为不再使用已经可以回收了？这里就需要提到以下几种垃圾回收算法了。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924213212214.png"
	width="1075"
	height="570"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924213212214_hu15841513339937815531.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924213212214_hu2325100229117044554.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="188"
		data-flex-basis="452px"
	
></p>
<h5 id="引用计数法">引用计数法
</h5><p>我们知道，如果我们要经常操作一个对象，那么首先一定会创建一个引用变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// str就是一个引用类型的变量，它持有对后面字符串对象的引用，可以代表后面这个字符串对象本身</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="s">&#34;lbwnb&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// str.xxxxx.·</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>实际上，我们会发现，只要一个对象还有使用价值，我们就会通过它的引用变量来进行操作，那么可否这样判断一个对象是否还需要被使用：</p>
<ul>
<li>
<p>每个对象都包含一个 <strong>引用计数器</strong>，用于存放引用计数（其实就是存放被引用的次数）</p>
</li>
<li>
<p>每当有一个地方引用此对象时，引用计数 +1</p>
</li>
<li>
<p>当引用失效（比如离开了局部变量的作用域或是引用被设定为 null）时，引用计数 -1</p>
</li>
<li>
<p>当引用计数为 0 时，表示此对象不可能再被使用，因为这时我们已经没有任何方法可以得到此对象的引用了</p>
</li>
</ul>
<p>但是这样存在一个问题，如果两个对象相互引用呢?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Test</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Test</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="na">another</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="na">another</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 这里直接把 a 和 b 赋值为 null，这样前面的两个对象我们=不可能再得到了，但是由于 another 的存在，这两个对象的引用计数永远为 1，不会被引用计数法所清除</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Test</span><span class="w"> </span><span class="n">another</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>按照引用计数算法，那么当出现以上情况时，虽然我们无法在得到此对象的引用了，并且此对象我们也无需再使用，但是由于这两个对象直接存在相互引用的情况，那么引用计数器的值将会永远是1，但是实际上此对象已经没有任何用途了。所以引用计数法并不是最好的解决方案。</p>
<h5 id="可达性分析算法">可达性分析算法
</h5><p>目前比较主流的编程语言（包括Java），一般都会使用可达性分析算法来判断对象是否存活，它采用了类似于树结构的搜索机制。</p>
<p>首先每个对象的引用都有机会成为树的根节点（GC Roots），可以被选定作为根节点条件如下：</p>
<ul>
<li>位于虚拟机栈的栈帧中的本地变量表中所引用到的对象（其实就是我们方法中的局部变量）同样也包括本地方法栈中 JNI 引用的对象</li>
<li>类的静态成员变量引用的对象</li>
<li>方法区中，常量池里面引用的对象，比如我们之前提到的 String 类型对象</li>
<li>被添加了锁的对象（比如 synchronized 关键字）</li>
<li>虚拟机内部需要用到的对象</li>
</ul>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214356364.png"
	width="1075"
	height="401"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214356364_hu9162694893707293063.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214356364_hu9822696662112963020.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="268"
		data-flex-basis="643px"
	
></p>
<p>一旦已经存在的根节点不满足存在的条件时，那么根节点与对象之间的连接将被断开。此时虽然对象 1 仍存在对其他对象的引用，但是由于其没有任何根节点引用，所以此对象即可被判定为不再使用。比如某个方法中的局部变量引用，在方法执行完成返回之后：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214517649.png"
	width="1076"
	height="390"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214517649_hu2846051370740612700.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214517649_hu3465443548923906644.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="275"
		data-flex-basis="662px"
	
></p>
<p>这样就能很好地解决我们刚刚提到的循环引用问题，我们再来重现一下出现循环引用的情况：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214617579.png"
	width="1075"
	height="256"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214617579_hu1088454365735671854.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214617579_hu6261998109063279228.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="419"
		data-flex-basis="1007px"
	
></p>
<p>可以看到，对象1和对象2依然是存在循环引用的，但是只有他们各自的 GCRoots 断开，那么就会变成下面这样：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214712527.png"
	width="1084"
	height="340"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214712527_hu15696772868168890401.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924214712527_hu7004646012247931675.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="318"
		data-flex-basis="765px"
	
></p>
<p>所以，我们最后进行一下总结：如果某个对象无法到达任何 GC Roots，则证明此对象是不可能再被使用的。</p>
<h5 id="最终判定">最终判定
</h5><p>虽然在经历了可达性分析算法之后基本可能判定哪些对象能够被回收，但是并不代表此对象一定会被回收，我们依然可以在最终判定阶段对其进行挽留。</p>
<p>0bject 类中的 finalize() 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此方法正是最终判定方法，如果子类重写了此方法，那么子类对象在被判定为可回收时，会进行二次确认，也就是执行 finalize() 方法，而在此方法中，当前对象是完全有可能重新建立 GC Roots 的！所以，如果在二次确认后对象不满足可回收的条件，那么此对象不会被回收，巧妙地逃过了垃圾回收的命运。比如下面这个例子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 这里直接赋值 null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//手动申请执行垃圾回收操作（只是申请，并不一定执行，一般来说会执行）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">gc</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 等待回收</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;不准回收！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924215510977.png"
	width="395"
	height="77"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924215510977_hu1389182478424150107.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924215510977_hu7379032670484474271.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="512"
		data-flex-basis="1231px"
	
></p>
<p>注意 finalize()方法并不是在主线程调用的，而是虚拟机自动建立的一个低优先级的 Finalizer 线程（正是因为优先级比较低，所以前面才需要等待1秒钟）进行处理，我们可以稍微修改一下看看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span><span class="o">[</span><span class="n">Finalizer</span><span class="p">,</span><span class="n">8</span><span class="p">,</span><span class="n">system</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main$Test</span><span class="nd">@1b6d3586</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>同时，同一个对象的 finalize() 方法只会有一次调用机会，也就是说，如果我们连续两次这样操作，那么第二次，对象必定被回收：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Test</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 这里直接赋值 null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//手动申请执行垃圾回收操作（只是申请，并不一定执行，一般来说会执行）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">gc</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 等待回收</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">gc</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span><span class="o">[</span><span class="n">Finalizer</span><span class="p">,</span><span class="n">8</span><span class="p">,</span><span class="n">system</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">org</span><span class="p">.</span><span class="na">example</span><span class="p">.</span><span class="na">Main$Test</span><span class="nd">@1b6d3586</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kc">null</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当然， finalize() 方法也并不是专门防止对象被回收的，我们可以使用它来释放一些程序使用中的资源等</p>
<p>最后，总结成一张图:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220050331.png"
	width="1078"
	height="388"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220050331_hu16626413642630840211.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220050331_hu16052973452108448647.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="277"
		data-flex-basis="666px"
	
></p>
<p>当然，除了堆中的对象以外，方法区中的数据也是可以被垃圾回收的，但是回收条件比较严格，这里就暂时不谈了。</p>
<h4 id="垃圾回收算法">垃圾回收算法
</h4><p>前面我们介绍了对象存活判定算法，现在我们已经可以准确地知道堆中的哪些对象可以被回收了，那么，接下来就该考虑如何对对象进行回收了，垃圾收集器会不定期地检查堆中的对象，查看它们是否满足被回收的条件。我们该如何对这些对象进行回收，是一个一个判断是否需要回收吗？</p>
<h5 id="分代收集机制">分代收集机制
</h5><p>实际上，如果我们对堆中的每一个对象都依次判断是否需要回收，这样的效率其实是很低的，那么有没有更好地回收机制呢？第一步，我们可以对堆中的对象进行分代管理。</p>
<p>比如某些对象，在多次垃圾回收时，都未被判定为可回收对象，我们完全可以将这一部分对象放在一起，并让垃圾收集器减少回收此区域对象的频率，这样就能很好地提高垃圾回收的效率了。</p>
<p>因此，Java 虚拟机将堆内存划分为<strong>新生代</strong>、<strong>老年代</strong>和<strong>永久代</strong>（其中永久代是 HotSpot 虚拟机特有的概念，在 JDK8 之前方法区实际上就是采用的永久代作为实现，而在 JDK8 之后，方法区由元空间实现，并且使用的是本地内存，容量大小取决于物理机实际大小，之后会详细介绍）这里我们主要讨论的是<strong>新生代</strong>和<strong>老年代</strong>。</p>
<p>不同的分代内存回收机制也存在一些不同之处，在 HotSpot 虚拟机中，新生代被划分为三块，一块较大的 Eden 空间和两块较小的 Survivor 空间，默认比例为 8:1:1，老年代的 GC 频率相对较低，永久代一般存放类信息等（其实就是方法区的实现）如图所示</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220546113.png"
	width="1078"
	height="407"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220546113_hu13048389060904900507.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220546113_hu10231646725198440592.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="264"
		data-flex-basis="635px"
	
></p>
<p>那么它是如何运作的呢?</p>
<p>首先，所有新创建的对象，在一开始都会进入到新生代的 Eden 区（如果是大对象会被直接丢进老年代），在进行新生代区域的垃圾回收时，首先会对所有新生代区域的对象进行扫描，并回收那些不再使用对象：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220847564.png"
	width="1072"
	height="244"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220847564_hu5060452725643458082.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924220847564_hu10187026566990823881.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="439"
		data-flex-basis="1054px"
	
></p>
<p>接着，在一次垃圾回收之后，Ede n区域没有被回收的对象，会进入到 Sunivor 区。在一开始 From 和 To 都是空的，而 GC 之后，所有 Eden 区域存活的对象都会直接被放入到 From 区，最后 From 和 To 会发生一次交换，也就是说目前存放我们对象的 From 区，变为 To 区而 To 区变为 From 区：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924221150614.png"
	width="1075"
	height="267"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924221150614_hu12642041278760864624.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924221150614_hu18223617838703843251.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="402"
		data-flex-basis="966px"
	
></p>
<p>接着就是下一次垃圾回收了，操作与上面是一样的，不过这时由于我们 To区域中已经存在对象了，所以，在 Eden 区的存活对象复制到 From 区之后，所有 To 区域中的对象会进行年龄判定（每经历一轮 GC 年龄+1，如果对象的年龄大于 默认值为15 ，那么会直接进入到老年代，否则移动到 From 区）</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924221254714.png"
	width="1073"
	height="264"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924221254714_hu5694200551088095780.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924221254714_hu315187859511685541.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="406"
		data-flex-basis="975px"
	
></p>
<p>最后像上面一样交换 To 区和 From 区，之后不断重复以上步骤</p>
<p>而垃圾收集也分为:</p>
<ul>
<li>
<p>Minor GC - 次要垃圾回收，主要进行新生代区域的垃圾收集</p>
<ul>
<li>触发条件:新生代的 Eden 区容量已满时</li>
</ul>
</li>
<li>
<p>MajorGC - 主要垃圾回收，主要进行老年代的垃圾收集</p>
</li>
<li>
<p>Full GC - 完全垃圾回收，对整个 Java 堆内存和方法区进行垃圾回收</p>
<ul>
<li>
<p>触发条件1：每次晋升到老年代的对象平均大小大于老年代剩余空间</p>
</li>
<li>
<p>触发条件2：Minor GC 后存活的对象超过了老年代剩余空间</p>
</li>
<li>
<p>触发条件3：永久代内存不足（JDK8之前）</p>
</li>
<li>
<p>触发条件4：手动调用 System.gc() 方法</p>
</li>
</ul>
</li>
</ul>
<p>我们可以添加启动参数来查看 JVM 的 GC 日志：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222043519.png"
	width="174"
	height="23"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222043519_hu2078745307911849591.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222043519_hu9748205112597531581.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="756"
		data-flex-basis="1815px"
	
></p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222213710.png"
	width="1059"
	height="432"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222213710_hu4281348773270332823.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222213710_hu4912087527407561356.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="245"
		data-flex-basis="588px"
	
></p>
<p>现在我们还只能大致看懂 GC 日志，不过在学习完成本章全部内容后，我们就可以轻松阅读了。</p>
<h5 id="空间分配担保">空间分配担保
</h5><p>我们可以思考一下，有没有这样一种极端情况（正常情况下新生代的回收率是很高的，所以说不用太担心会经常出现这种问题），在一次GC后，新生代 Eden 区仍然存在大量的对象（因为GC之后存活对象会进入到一个 Survivor 区，但是很明显这时已经超出 Sunvivor 区的容量了，肯定是装不下的）那么现在该怎么办？</p>
<p>这时就需要用到空间分配担保机制了，可以把 Sunivor 区无法容纳的对象直接送到老年代，让老年代进行分配担保（当然老年代也得装得下才行）在现实生活中，贷款会指定担保人，就是当借款人还不起钱的时候由担保人来还钱。</p>
<p>当新生代无法容纳更多的的对象时，可以把新生代中的对象移动到老年代中，这样新生代就腾出了空间来容纳更多的对象。</p>
<p>好，那既然新生代装不下就丢给老年代，那么要是老年代也装不下新生代的数据呢？这时，老年代肯定担保人是当不成了，那么这样的话，首先会判断一下之前的每次垃圾回收进入老年代的平均大小是否小于当前老年代的剩余空间，如果小于，那么说明也许可以放得下（不过也仅仅是也许，依然有可能放不下，因为判断的实际上只是平均值，万一这一次突然非常大呢），否则，会先来一次 FullGC，进行一次大规模垃圾回收，来尝试腾出空间，再次判断老年代是否有空间存放，要是还是装不下，直接抛出 OOM 错误，摆烂。</p>
<p>最后，总结一下一次 Minor GC 的整个过程：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222651102.png"
	width="1082"
	height="441"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222651102_hu5577099240470375078.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240924222651102_hu16945231712877516560.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="245"
		data-flex-basis="588px"
	
></p>
<h5 id="标记-清除算法">标记-清除算法
</h5><p>前面我们已经了解了整个堆内存实际上是以分代收集机制为主，但是依然没有讲到具体的收集过程，那么，具体的回收过程又是什么样的呢?首先我们救了解一下最古老的 标记-清除 算法。</p>
<p>首先标记出所有需要回收的对象，然后再依次回收掉被标记的对象，或是标记出所有不需要回收的对象，只回收未标记的对象。实际上这种算法是非常基础的，并且最易于理解的（这里对象我就以一个方框代替了，当然实际上存放是我们前说到的 GC Roots 形式）</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213025148.png"
	width="1070"
	height="244"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213025148_hu8378767733180071782.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213025148_hu3203046715221442621.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="438"
		data-flex-basis="1052px"
	
></p>
<p>虽然此方法非常简单，但是缺点也是非常明显的，首先如果内存中存在大量的对象，那么可能就会存在大量的标记，并且大规模进行清除。并且一次标记清除之后，连续的内存空间可能会出现许许多多的空隙，碎片化会导致连续内存空间利用率降低。</p>
<h5 id="标记-复制法">标记-复制法
</h5><p>既然标记清除算法在面对大量对象时效率低，那么我们可以采用标记-复制算法。它将容量分为同样大小的两块区域</p>
<p>标记复制算法，实际上就是将内存区域划分为大小相同的两块区域，每次只使用其中的一块区域，每次垃圾回收结束后，将所有存活的对象全部复制到另一块区域中，并一次性清空当前区域。虽然浪费了一些时间进行复制操作，但是这样能够很好地解决对象大面积回收后空间碎片化严重的问题。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213237912.png"
	width="1075"
	height="488"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213237912_hu12806611517816563198.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213237912_hu5531896466795513797.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="220"
		data-flex-basis="528px"
	
></p>
<p>这种算法就非常适用于新生代（因为新生代的回收效率极高，一般不会留下太多的对象）的垃圾回收，而我们之前所说的新生代 Survivor 区其实就是这个思路，包括 8:1:1 的比例也正是为了对标记复制算法进行优化而采取的。</p>
<h5 id="标记-整理算法">标记-整理算法
</h5><p>虽然 标记-复制 算法能够很好地应对新生代高回收率的场景，但是放到老年代，它就显得很鸡肋了。我们知道，一般长期都回收不到的对象，才有机会进入到老年代，所以老年代一般都是些钉子户，可能一次 GC 后，仍然存留很多对象。而标记复制算法会在 GC 后完整复制整个区域内容，并且会折损 50% 的区域，显然这并不适用于老年代。</p>
<p>那么我们能否这样，在标记所有待回收对象之后，不急着去进行回收操作，而是将所有待回收的对象整齐排列在一段内存空间中，而需要回收的对象全部往后丢，这样，前半部分的所有对象都是无需进行回收的，而后半部分直接一次性清除即可。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213418503.png"
	width="1077"
	height="139"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213418503_hu14433279986826392863.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240925213418503_hu15070390181233318407.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="774"
		data-flex-basis="1859px"
	
></p>
<p>虽然这样能保证内存空间充分使用，并且也没有标记复制算法那么繁杂，但是缺点也是显而易见的，它的效率比前两者都低。甚至,由于需要修改对象在内存中的位置，此时程序必须要暂停才可以，在极端情况下，可能会导致整个程序发生停顿（被称为“Stop The World”）。</p>
<p>所以，我们可以将标记清除算法和标记整理算法混合使用，在内存空间还不是很凌乱的时候，采用标记清除算法其实是没有多大问题的，当内存空间凌乱到一定程度后，我们可以进行一次标记整理算法。</p>
<h4 id="垃圾收集器实现">垃圾收集器实现
</h4><p>聊完了对象存活判定和垃圾回收算法，接着我们就要看看具体有哪些垃圾回收器的实现了。我们可以自由地为新生代和老年代选择更适合它们的收集器。</p>
<h5 id="serial-收集器">Serial 收集器
</h5><p>这款垃圾收集器也是元老级别的收集器了，在 JDK1.3.1 之前，是虚拟机新生代区域收集器的唯一选择。这是一款单线程的垃圾收集器，也就是说，当开始进行垃圾回收时，需要暂停所有的线程，直到垃圾收集工作结束。它的新生代收集算法采用的是标记复制算法，老年代采用的是标记整理算法。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154104446.png"
	width="1084"
	height="270"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154104446_hu4400434504211523994.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154104446_hu15762832197202531673.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="401"
		data-flex-basis="963px"
	
></p>
<p>可以看到，当进入到垃圾回收阶段时，所有的用户线程必须等待 GC 线程完成工作，就相当于你打一把 LOL 40 分钟，中途每隔 1 分钟网络就卡 5 秒钟，可能这时你正在打团，结果你被物理控制直接在那里站了 5 秒钟，这确实让人难以接受。</p>
<p>虽然缺点很明显，但是优势也是显而易见的：</p>
<p>1.设计简单而高效。
2.在用户的桌面应用场景中，内存一般不大，可以在较短时间内完成垃圾收集，只要不频繁发生，使用串行回收器是可以接受的。</p>
<p>所以，在客户端模式（一般用于一些桌面级图形化界面应用程序）下的新生代中，默认垃圾收集器至今依然是 Serial 收集器。我们可以在 java -version 中查看默认的客户端模式:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154306114.png"
	width="903"
	height="96"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154306114_hu6249078828241998905.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154306114_hu4520156025669841529.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="940"
		data-flex-basis="2257px"
	
></p>
<p>我们可以在 jvm.cfg 文件中切换 JRE 为 Server VM 或是 Client VM ，默认路径为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">JDK安装目录/jre/lib/jvm.cfg
</span></span></code></pre></td></tr></table>
</div>
</div><p>比如我们需要将当前模式切换为客户端模式，那么我们可以这样编辑：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">	-client KNOWN
</span></span><span class="line"><span class="cl">	-server IGNORE
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="parnew-收集器">ParNew 收集器
</h5><p>这款垃圾收集器相当于是 Serial 收集器的多线程版本，它能够支持多线程垃圾收集：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154516988.png"
	width="1080"
	height="263"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154516988_hu14777481556545117379.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154516988_hu1026205092103131688.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="410"
		data-flex-basis="985px"
	
></p>
<p>除了多线程支持以外，其他内容基本与 Serial 收集器一致，并且目前某些 JVM 默认的服务端模式新生代收集器就是使用的 ParNew 收集器</p>
<h5 id="parallel-scavengeparallel-old收集器">Parallel Scavenge/Parallel Old收集器
</h5><p>Parallel Scavenge 同样是一款面向新生代的垃圾收集器，同样采用标记复制算法实现，在 JDK6 时也推出了其老年代收集器Paralel Old，采用标记整理算法实现：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154636057.png"
	width="1079"
	height="274"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154636057_hu10082915588007334826.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926154636057_hu14100715343005040730.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="393"
		data-flex-basis="945px"
	
></p>
<p>与 ParNew 收集器不同的是，它会自动衡量一个吞吐量，并根据吞吐量来决定每次垃圾回收的时间，这种自适应机制，能够很好地权衡当前机器的性能，根据性能选择最优方案。</p>
<p>目前 JDK8 采用的就是这种 Parallel Scavenge + Parallel Old 的垃圾回收方案。</p>
<h5 id="cms-收集器">CMS 收集器
</h5><p>在 JDK1.5。HotSpot 推出了一款在强交互应用中几乎可认为有划时代意义的垃圾收集器：CMS（Concurent-Mark-Sweep）收集器，这款收集器是 HotSpot 虛拟机中第一款真正意义上的并发（注意这里的并发和之前的并行是有区别的，并发可以理解为同时运行用户线程和 GC 线程，而并行可以理解为多条 GC 线程同时工作）收集器，它第一次实现了让垃圾收集线程与用户线程同时工作。</p>
<p>它主要采用标记清除算法：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155023771.png"
	width="1081"
	height="285"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155023771_hu11774347305641492830.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155023771_hu14777013363463928239.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="379"
		data-flex-basis="910px"
	
></p>
<p>它的垃圾回收分为 4 个阶段：</p>
<ul>
<li>初始标记（需要暂停用户线程）：这个阶段的主要任务仅仅只是标记出 GC Roots 能直接关联到的对象，速度比较快，不用担心会停顿太长时间</li>
<li>并发标记：从 GC Roots 的直接关联对象开始遍历整个对象图的过程，这个过程耗时较长但是不需要停顿用户线程，可以与垃圾收集线程一起并发运行</li>
<li>重新标记（需要暂停用户线程）：由于并发标记阶段可能某些用户线程会导致标记产生变动，因此这里需要再次暂停所有线程进行并行标记，这个时间会比初始标记时间长一丢丢</li>
<li>并发清除：最后就可以直接将所有标记好的无用对象进行删除，因为这些对象程序中也用不到了，所以可以与用户线程并发运行</li>
</ul>
<p>虽然它的优点非常之大，但是缺点也是显而易见的，我们之前说过，标记清除算法会产生大量的内存碎片，导致可用连续空间逐渐变少，长期这样下来，会有更高的概率触发 Full GC，并且在与用户线程并发执行的情况下，也会占用一部分的系统资源，导致用户线程的运行速度一定程度上减慢</p>
<p>不过，如果你希望的是最低的 GC 停顿时间，这款垃圾收集器无疑是最佳选择，不过自从 G1 收集器问世之后，CMS 收集器不再推荐使用了</p>
<h5 id="garbage-firstg1收集器">Garbage First（G1）收集器
</h5><p>此垃圾收集器也是一款划时代的垃圾收集器，在 JDK7 的时候正式走上历史舞台，它是一款主要面向于服务端的垃圾收集器，并且在 JDK9 时，取代了 JDK8 默认的 Parallel Scavenge+ Parallel Old 的回收方案。</p>
<p>我们知道，我们的垃圾回收分为 Minor Gc、Major GC和Full GC，它们分别对应的是新生代，老年代和整个堆内存的垃圾回收，而 G1 收集器巧妙地绕过了这些约定，它将整个 Java 堆划分成 2048 个大小相同的独立 Reqion 块，每个 Region 块 的大小根据堆空间的实际大小而定，整体被控制在 1MB 到 32MB 之间，且都为 2 的 N 次幂。所有的 Region 大小相同，且在 JVM 的整个生命周期内不会发生改变</p>
<p>那么分出这些 Region 有什么意义呢？每一个 Region 都可以根据需要，自由决定扮演哪个角色（Eden、Sunvivor 和老年代），收集器会根据对应的角色采用不同的回收策略。此外，G1 收集器还存在一个 Humongous 区域，它专门用于存放大对象（一般认为大小超过了 Region 容量一半的对象为大对象）这样，新生代、老年代在物理上，不再是一个连续的内存区域，而是到处分布的。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155752520.png"
	width="1049"
	height="293"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155752520_hu15796028937446884214.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155752520_hu7188388739686319420.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="358"
		data-flex-basis="859px"
	
></p>
<p>它的回收过程与 CMS 大体类似：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155821017.png"
	width="1078"
	height="294"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155821017_hu5974349767969774941.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926155821017_hu12514422530112809177.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="366"
		data-flex-basis="880px"
	
></p>
<p>分为以下四个步骤：</p>
<ul>
<li>初始标记（暂停用户线程）：仅仅只是标记一下 GC Roots 能直接关联到的对象，并且修改 TAMS 指针的值，让下一阶段用户线程并发运行时，能正确地在可用 Region 中分配新对象，这个阶段需要停顿线程，但耗时很短，而且时借用进行 Minor GC 的时候同步完成的，所以 G1 收集器在这个阶段实际并没有额外的停顿</li>
<li>并发标记：从 GC Root 开始对堆中的队形进行可达性分析，递归扫描整个堆里的对象图，找出要回收的对象，这个阶段耗时较长，但可与用户线程并发执行</li>
<li>最终标记（暂停用户线程）：对用户线程做一个短暂的暂停，用于处理并发标记阶段漏标的那部分对象</li>
<li>筛选回收：负责更新 Region 的统计数据，对各个 Region 的回收价值和成本进行排序，根据用户所期望的停顿时间来制定回收计划，可以自由选择任意多个 Region 构成回收集，然后把决定回收的那一步能否 Region 的存活对象复制到空的 Region 中，在清理掉整个旧 Region 的全部空间，这里的操作设计存活对象的移动，是必须暂停用户线程，由多个收集器线程并行完成的</li>
</ul>
<h4 id="元空间">元空间
</h4><p>JDK8 之前，Hotspot 虚拟机的方法区实际上是永久代实现的。在 JDK8 之后，Hotspot 虚拟机不再使用永久代，而是采用了全新的元空间。类的元信息被存储在元空间中。元空间没有使用堆内存，而是与堆不相连的本地内存区域。所以，理论上系统可以使用的内存有多大，元空间就有多大，所以不会出现永久代存在时的内存溢出问题。这项改造也是有必要的，永久代的调优是很困难的，虽然可以设置永久代的大小，但是很难确定一个合适的大小，因为其中的影响因素很多，比如类数量的多少、常量数量的多少等。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926160853866.png"
	width="1079"
	height="263"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926160853866_hu8540244421751745056.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926160853866_hu2505642573263983228.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="410"
		data-flex-basis="984px"
	
></p>
<p>因此在JDK8时直接将本地内存作为元空间（Metaspace）的区域，物理内存有多大，元空间内存就可以有多大，这样永久代的空间分配问题就解决了，所以最终它变成了这样：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926161022325.png"
	width="1067"
	height="440"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926161022325_hu13673039261833697150.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926161022325_hu12282471923562199111.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="242"
		data-flex-basis="582px"
	
></p>
<p>到此，我们对于 JVM 内存区域的讲解就基本完成了。</p>
<h4 id="其他区引用类型">其他区引用类型
</h4><p>最后，我们来介绍一下其他引用类型</p>
<p>我们知道，在 Java 中，如果变量是一个对象类型的，那么它实际上存放的是对象的引用，但是如果是一个基本类型，那么存放的就是基本类型的值。实际上我们平时代码中类似于<code>0bject o = new 0bject()</code>这样的的引用类型，细分之后可以称为 <code>强引用</code>。</p>
<p>我们通过前面的学习可以明确，如果方法中存在这样的 <code>强引用</code> 类型，现在需要回收强引用所指向的对象，那么要么此方法运行结束，要么引用连接断开，否则被引用的对象是无法被判定为可回收的，因为我们说不定后面还要使用它。</p>
<p>所以，当 JVM 内存空间不足时，JVM 宁愿抛出 Out0fMemoryError 使程序异常终止，也不会靠随意回收具有强引用的“存活”对象来解决内存不足的问题。</p>
<p>除了强引用之外，Java也为我们提供了三种额外的引用类型：</p>
<h5 id="软引用">软引用
</h5><p>软引用不像强引用那样不可回收，当 JVM  认为内存不足时，会去试图回收软引用指向的对象，即 JVM 会确保在抛出OutOfMemoryError 之前，清理软引用指向的对象。当然，如果内存充足，那么是不会轻易被回收的。</p>
<p>我们可以通过以下方式来创建一个软引用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 强引用写法：Object obj = new Object();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 软引用写法：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SoftReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 使用 get 方法就可以获取到软引用所指的对象了</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到软引用还存在一个带队列的构造方法，软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java 虚拟机就会把这个软引用加入到与之关联的引用队列中。</p>
<p>这里我们来进行一个测试，首先设定一下参数，是最大堆内存为 10 M，并且答应 GC 日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">-Xms10m -Xmx10m -XX:+PrintGCDetails
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着运行以下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ReferenceQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReferenceQueue</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SoftReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">(),</span><span class="w"> </span><span class="n">queue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="s">&#34;aaaaaa&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;内存溢出&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;软引用对象：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reference</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">poll</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1024K-&gt;504K<span class="o">(</span>1536K<span class="o">)]</span> 1024K-&gt;704K<span class="o">(</span>5632K<span class="o">)</span>, 0.0011488 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.00 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl">java.lang.ref.SoftReference@1b6d3586
</span></span><span class="line"><span class="cl"><span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1526K-&gt;484K<span class="o">(</span>1536K<span class="o">)]</span> 1726K-&gt;1156K<span class="o">(</span>5632K<span class="o">)</span>, 0.0007738 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.00 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1508K-&gt;512K<span class="o">(</span>1536K<span class="o">)]</span> 2180K-&gt;1905K<span class="o">(</span>5632K<span class="o">)</span>, 0.0011489 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.00 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1535K-&gt;512K<span class="o">(</span>1536K<span class="o">)]</span> 2929K-&gt;2951K<span class="o">(</span>5632K<span class="o">)</span>, 0.0020703 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.00 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>GC <span class="o">(</span>Allocation Failure<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1536K-&gt;512K<span class="o">(</span>1536K<span class="o">)]</span> 3975K-&gt;4008K<span class="o">(</span>5632K<span class="o">)</span>, 0.0020181 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.00 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>Full GC <span class="o">(</span>Ergonomics<span class="o">)</span> <span class="o">[</span>PSYoungGen: 512K-&gt;0K<span class="o">(</span>1536K<span class="o">)]</span> <span class="o">[</span>ParOldGen: 3496K-&gt;3169K<span class="o">(</span>4096K<span class="o">)]</span> 4008K-&gt;3169K<span class="o">(</span>5632K<span class="o">)</span>, <span class="o">[</span>Metaspace: 3450K-&gt;3450K<span class="o">(</span>1056768K<span class="o">)]</span>, 0.0488801 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.41 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.05 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl">.........
</span></span><span class="line"><span class="cl"><span class="o">[</span>Full GC <span class="o">(</span>Ergonomics<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1024K-&gt;1024K<span class="o">(</span>1536K<span class="o">)]</span> <span class="o">[</span>ParOldGen: 4035K-&gt;4035K<span class="o">(</span>4096K<span class="o">)]</span> 5059K-&gt;5059K<span class="o">(</span>5632K<span class="o">)</span>, <span class="o">[</span>Metaspace: 3535K-&gt;3535K<span class="o">(</span>1056768K<span class="o">)]</span>, 0.0543443 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.61 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.05 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl">内存溢出
</span></span><span class="line"><span class="cl">软引用对象：null
</span></span><span class="line"><span class="cl">java.lang.ref.SoftReference@1b6d3586
</span></span><span class="line"><span class="cl"><span class="o">[</span>Full GC <span class="o">(</span>Ergonomics<span class="o">)</span> <span class="o">[</span>PSYoungGen: 1024K-&gt;0K<span class="o">(</span>1536K<span class="o">)]</span> <span class="o">[</span>ParOldGen: 4046K-&gt;714K<span class="o">(</span>4096K<span class="o">)]</span> 5070K-&gt;714K<span class="o">(</span>5632K<span class="o">)</span>, <span class="o">[</span>Metaspace: 3548K-&gt;3548K<span class="o">(</span>1056768K<span class="o">)]</span>, 0.0047166 secs<span class="o">]</span> <span class="o">[</span>Times: <span class="nv">user</span><span class="o">=</span>0.20 <span class="nv">sys</span><span class="o">=</span>0.00, <span class="nv">real</span><span class="o">=</span>0.00 secs<span class="o">]</span> 
</span></span><span class="line"><span class="cl">Heap
</span></span><span class="line"><span class="cl"> PSYoungGen      total 1536K, used 41K <span class="o">[</span>0x00000000ffe00000, 0x0000000100000000, 0x0000000100000000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  eden space 1024K, 4% used <span class="o">[</span>0x00000000ffe00000,0x00000000ffe0a620,0x00000000fff00000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  from space 512K, 0% used <span class="o">[</span>0x00000000fff00000,0x00000000fff00000,0x00000000fff80000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  to   space 512K, 0% used <span class="o">[</span>0x00000000fff80000,0x00000000fff80000,0x0000000100000000<span class="o">)</span>
</span></span><span class="line"><span class="cl"> ParOldGen       total 4096K, used 714K <span class="o">[</span>0x00000000ffa00000, 0x00000000ffe00000, 0x00000000ffe00000<span class="o">)</span>
</span></span><span class="line"><span class="cl">  object space 4096K, 17% used <span class="o">[</span>0x00000000ffa00000,0x00000000ffab2968,0x00000000ffe00000<span class="o">)</span>
</span></span><span class="line"><span class="cl"> Metaspace       used 3574K, capacity 4564K, committed 4864K, reserved 1056768K
</span></span><span class="line"><span class="cl">  class space    used 378K, capacity 388K, committed 512K, reserved 1048576K
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="弱引用">弱引用
</h5><p>弱引用比软引用的生命周期还要短，在进行垃圾回收时，不管当前内存空间是否充足，都会回收它的内存。</p>
<p>我们可以像这样创建一个弱引用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">reference</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用方法和软引用是差不多的，但是如果我们在这之前手动进行一次 GC：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">weakReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WeakReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">softReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SoftReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">gc</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;软引用对象：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">softReference</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;弱引用对象：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">weakReference</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926163441631.png"
	width="539"
	height="68"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926163441631_hu13976191112424791872.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926163441631_hu5280136186384765579.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="792"
		data-flex-basis="1902px"
	
></p>
<p>可以看到，弱引用对象直接就被回收了，而软引用对象没有被回收。同样的，它也支持 ReferenceQueue，和软引用用法一致，这里就不多做介绍了</p>
<p>WeakHashMap，正是一种类似于弱引用的 HashMap 类，如果 Map 中的 Key 没有其他引用那么此 Map 会自动丢弃此键值对：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Integer</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">WeakHashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">weakHashMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WeakHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">weakHashMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;yyds&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">weakHashMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">a</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">gc</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">weakHashMap</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926163724738.png"
	width="210"
	height="62"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926163724738_hu17117024117764920482.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926163724738_hu7800710425480931336.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="338"
		data-flex-basis="812px"
	
></p>
<p>可以看到，当变量 a 的引用断开后，这时只有 WeakHashMap 本身对此对象存在引用，所以在 GC 之后，这个键值对就自动被舍弃了。所以说这玩意，就挺适合拿去做缓存的。</p>
<h5 id="虚引用鬼引用">虚引用（鬼引用）
</h5><p>虚引用相当于没有引用，随时都有可能会被回收。</p>
<p>看看它的源码，非常简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PhantomReference</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Reference</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Returns this reference object&#39;s referent.  Because the referent of a
</span></span></span><span class="line"><span class="cl"><span class="cm">     * phantom reference is always inaccessible, this method always returns
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;code&gt;null&lt;/code&gt;.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return  &lt;code&gt;null&lt;/code&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Creates a new phantom reference that refers to the given object and
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is registered with the given queue.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt; It is possible to create a phantom reference with a &lt;tt&gt;null&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * queue, but such a reference is completely useless: Its &lt;tt&gt;get&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * method will always return {@code null} and, since it does not have a queue,
</span></span></span><span class="line"><span class="cl"><span class="cm">     * it will never be enqueued.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param referent the object the new phantom reference will refer to
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param q the queue with which the reference is to be registered,
</span></span></span><span class="line"><span class="cl"><span class="cm">     *          or &lt;tt&gt;null&lt;/tt&gt; if registration is not required
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PhantomReference</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">referent</span><span class="p">,</span><span class="w"> </span><span class="n">ReferenceQueue</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">super</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="n">referent</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>也就是说我们无论调用多少次 get() 方法得到的永远都是 nu11，因为虚引用本身就不算是个引用，相当于这个对象不存在任何引用并且只能使用带队列的构造方法，以便对象被回收时接到通知。</p>
<p>最后，Java 中 4 种引用的级别由高到低依次为：<strong>强引用 &gt;软引用 &gt;弱引用 &gt; 虚引用</strong></p>
<h2 id="类与类加载">类与类加载
</h2><h3 id="类文件结构">类文件结构
</h3><p>在我们学习 C 语言的时候，我们的编程过程会经历如下几个阶段：写代码、保存、编译、运行。实际上，最关键的一步是编译，因为只有经历了编译之后，我们所编写的代码才能够翻译为机器可以直接运行的二进制代码，并且在不同的操作系统下，我们的代码都需要进行一次编译之后才能运行。</p>
<blockquote>
<p>如果全世界所有的计算机指令集只有x86一种，操作系统只有 Windows 一种，那也许就不会有 Java 语言的出现。</p>
</blockquote>
<p>随着时代的发展，人们迫切希望能够在不同的操作系统、不同的计算机架构中运行同一套编译之后的代码。本地代码不应该是我们编程的唯一选择，所以，越来越多的语言选择了与操作系统和机器指令集无关的中立格式作为编译后的存储格式。</p>
<p>“一次编写，到处运行”，Java最引以为傲的口号，标志着平台不再是限制编程语言的阻碍。</p>
<p>实际上，Java 正式利用了这样的解决方案，将源代码编译为平台无关的中间格式，并通过对应的 Java 虚拟机读取和运行这些中间格式的编译文件，这样，我们只需要考虑不同平台的虚拟机如何编写，而 Java 语言本身很轻松地实现了跨平台。</p>
<p>现在，越来越多的开发语言都支持将源代码编译为  .class 字节码文件格式，以便能够直接交给 JVM 运行，包括 Kotlin（安卓开发官方指定语言）、Groovy、Scala 等。</p>
<p>那么，让我们来看看，我们的源代码编译之后，是如何保存在字节码文件中的。</p>
<hr>
<h4 id="类文件信息">类文件信息
</h4><p>我们之前都是使用 javap 命令来对字节码文件进行反编译查看的，那么，它以二进制格式是怎么保存呢？我们可以使用VS code 下载 Hex Editor 插件来以十六进制查看字节码文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>找到我们在 IDEA 中编译出来的 class 文件，将其拖动进去:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926165711243.png"
	width="859"
	height="829"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926165711243_hu18129161081398407253.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926165711243_hu8860874965394559169.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="103"
		data-flex-basis="248px"
	
></p>
<p>可以看到整个文件中，全是一个字节一个字节分组的样子，从左上角开始，一行一行向下读取。可以看到在右侧中还出现了一些我们之前也许见过的字符串，比如<code>&lt;init&gt;</code>、<code>Object</code>等</p>
<p>实际上 Class 文件采用了一种类似于 C 中结构体的伪结构来存储数据（当然我们直接看是看不出来的）但是如果像这样呢：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Classfile /D:/code/blogchat-java/untitled/target/classes/org/example/Main.class
</span></span><span class="line"><span class="cl">  Last modified 2024-9-26<span class="p">;</span> size <span class="m">450</span> bytes                                      
</span></span><span class="line"><span class="cl">  MD5 checksum d9b6dcbc5f453955fc4b5c9562eac423                                
</span></span><span class="line"><span class="cl">  Compiled from <span class="s2">&#34;Main.java&#34;</span>                                                    
</span></span><span class="line"><span class="cl">public class org.example.Main                                                  
</span></span><span class="line"><span class="cl">  minor version: <span class="m">0</span>
</span></span><span class="line"><span class="cl">  major version: <span class="m">52</span>
</span></span><span class="line"><span class="cl">  flags: ACC_PUBLIC, ACC_SUPER
</span></span><span class="line"><span class="cl">Constant pool:
</span></span><span class="line"><span class="cl">   <span class="c1">#1 = Methodref          #3.#21         // java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#2 = Class              #22            // org/example/Main</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#3 = Class              #23            // java/lang/Object</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#4 = Utf8               &lt;init&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#5 = Utf8               ()V</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#6 = Utf8               Code</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#7 = Utf8               LineNumberTable</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#8 = Utf8               LocalVariableTable</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#9 = Utf8               this</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#10 = Utf8               Lorg/example/Main;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#11 = Utf8               main</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#12 = Utf8               ([Ljava/lang/String;)V</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#13 = Utf8               args</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#14 = Utf8               [Ljava/lang/String;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#15 = Utf8               i</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#16 = Utf8               I</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#17 = Utf8               a</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#18 = Utf8               b</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#19 = Utf8               SourceFile</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#20 = Utf8               Main.java</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#21 = NameAndType        #4:#5          // &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#22 = Utf8               org/example/Main</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#23 = Utf8               java/lang/Object</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  public org.example.Main<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    descriptor: <span class="o">()</span>V
</span></span><span class="line"><span class="cl">    flags: ACC_PUBLIC
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">      <span class="nv">stack</span><span class="o">=</span>1, <span class="nv">locals</span><span class="o">=</span>1, <span class="nv">args_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">         0: aload_0
</span></span><span class="line"><span class="cl">         1: invokespecial <span class="c1">#1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">         4: <span class="k">return</span>
</span></span><span class="line"><span class="cl">      LineNumberTable:
</span></span><span class="line"><span class="cl">        line 3: <span class="m">0</span>
</span></span><span class="line"><span class="cl">      LocalVariableTable:
</span></span><span class="line"><span class="cl">        Start  Length  Slot  Name   Signature
</span></span><span class="line"><span class="cl">            <span class="m">0</span>       <span class="m">5</span>     <span class="m">0</span>  this   Lorg/example/Main<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  public static void main<span class="o">(</span>java.lang.String<span class="o">[])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    descriptor: <span class="o">([</span>Ljava/lang/String<span class="p">;</span><span class="o">)</span>V
</span></span><span class="line"><span class="cl">    flags: ACC_PUBLIC, ACC_STATIC
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">      <span class="nv">stack</span><span class="o">=</span>1, <span class="nv">locals</span><span class="o">=</span>4, <span class="nv">args_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">         0: bipush        <span class="m">10</span>
</span></span><span class="line"><span class="cl">         2: istore_1
</span></span><span class="line"><span class="cl">         3: iload_1
</span></span><span class="line"><span class="cl">         4: iinc          1, <span class="m">1</span>
</span></span><span class="line"><span class="cl">         7: istore_2
</span></span><span class="line"><span class="cl">         8: iinc          1, <span class="m">1</span>
</span></span><span class="line"><span class="cl">        11: iload_1
</span></span><span class="line"><span class="cl">        12: istore_3
</span></span><span class="line"><span class="cl">        13: <span class="k">return</span>
</span></span><span class="line"><span class="cl">      LineNumberTable:
</span></span><span class="line"><span class="cl">        line 5: <span class="m">0</span>
</span></span><span class="line"><span class="cl">        line 6: <span class="m">3</span>
</span></span><span class="line"><span class="cl">        line 7: <span class="m">8</span>
</span></span><span class="line"><span class="cl">        line 8: <span class="m">13</span>
</span></span><span class="line"><span class="cl">      LocalVariableTable:
</span></span><span class="line"><span class="cl">        Start  Length  Slot  Name   Signature
</span></span><span class="line"><span class="cl">            <span class="m">0</span>      <span class="m">14</span>     <span class="m">0</span>  args   <span class="o">[</span>Ljava/lang/String<span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="m">3</span>      <span class="m">11</span>     <span class="m">1</span>     i   I
</span></span><span class="line"><span class="cl">            <span class="m">8</span>       <span class="m">6</span>     <span class="m">2</span>     a   I
</span></span><span class="line"><span class="cl">           <span class="m">13</span>       <span class="m">1</span>     <span class="m">3</span>     b   I
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>乍一看，是不是感觉还真的有点结构体那味？</p>
<p>而结构体中，有两种允许存在的数据类型，一个是无符号数，还有一个是表。</p>
<ul>
<li>无符号数一般是基本数据类型，用 u1、u2、u4、u8 来表示，表示 1 个字节 ~ 8 个字节 的无符号数。可以表示数字、索引引用、数量值或是以 UTF-8 编码格式的字符串。</li>
<li>表包含多个无符号数，并且以 &ldquo;info&rdquo; 结尾。</li>
</ul>
<p>我们首先从最简单的开始看起</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926170328921.png"
	width="1193"
	height="857"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926170328921_hu7674681010732073216.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926170328921_hu9127750635492441730.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="139"
		data-flex-basis="334px"
	
></p>
<p>首先，我们可以看到，前 4 个字节（共32位）组成了魔数（其实就是表示这个文件是一个 JVM 可以运行的字节码文件，除了 Java 以外，其他某些文件中也采用了这种魔数机制来进行区分，这种方式比直接起个文件扩展名更安全）</p>
<p>字节码文件的魔数为：CAFEBABE（这名字能想出来也是挺难的了，毕竟4个bit位只能表示出A-F这几个字母）</p>
<p>紧接着魔数的后面 4 个字节存储的是字节码文件的版本号，注意前两个是次要版本号（现在基本都不用了，都是直接Java8、Java9这样命名了），后面两个是主要版本号，这里我们主要看主版本号，比如上面的就是 34，注意这是以 16 进制表示的，我们把它换算为 10 进制后，得到的结果为：34 -&gt; 3 * 16 + 4 = 52，其中 52 代表的是 JDK8 编译的字节码文件（51是JDK7、50是JDK6、53是 JDK9 以此类推）</p>
<p>JVM 会根据版本号决定是否能够运行，比如 JDK6 只能支持版本号为 1.1<del>6 的版本，也就是说必须是 Java6 之前的环境编译出来的字节码文件，否则无法运行。又比如我们现在安装的是 JDK8 版本，它能够支持的版本号为 1.1</del>8，那么如果这时我们有一个通过 Java7 编译出来的字节码文件，依然是可以运行的，所以说 Java 版本是向下兼容的。</p>
<p>紧接着，就是类的常量池了，这里面存放了类中所有的常量信息（注意这里的常量并不是指我们手动创建的 final 类型常量，而是程序运行一些需要用到的常量数据，比如字面量和符号引用等）由于常量的数量不是确定的，所以在最开始的位置会存放常量池中常量的数量（是从 1 开始计算的，不是 0，比如这里是 18，翻译为 10 进制就是 24，所以实际上有 23 个常量）</p>
<p>接着再往下，就是常量池里面的数据了，每一项常量池里面的数据都是一个表，我们可以看到他们都是以 info 结尾的:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926171028331.png"
	width="897"
	height="249"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926171028331_hu14282378807916713033.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926171028331_hu10969477478527718712.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="360"
		data-flex-basis="864px"
	
></p>
<p>我们来看看一个表中定义了哪些内容：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926171112150.png"
	width="1067"
	height="129"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926171112150_hu13597032995627588738.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926171112150_hu12565402258909503888.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="827"
		data-flex-basis="1985px"
	
></p>
<p>首先上来就会有一个 1 字节的无符号数，它用于表示当前常量的类型（常量类型有很多个）这里只列举一部分的类型介绍:</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: center">类型</th>
          <th style="text-align: center">标志</th>
          <th style="text-align: center">描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">CONSTANT_Utf8_info</td>
          <td style="text-align: center">1</td>
          <td style="text-align: center">UTF-8编码格式的字符串</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_Integer_info</td>
          <td style="text-align: center">3</td>
          <td style="text-align: center">整形字面量</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_Class_info</td>
          <td style="text-align: center">7</td>
          <td style="text-align: center">类或接口的符号引用</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_String_info</td>
          <td style="text-align: center">8</td>
          <td style="text-align: center">字符串类型的字面量</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_Fieldref_info</td>
          <td style="text-align: center">9</td>
          <td style="text-align: center">字段的符号引用</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_Methodref_info</td>
          <td style="text-align: center">10</td>
          <td style="text-align: center">方法的符号引用</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_MethodType_info</td>
          <td style="text-align: center">16</td>
          <td style="text-align: center">方法类型</td>
      </tr>
      <tr>
          <td style="text-align: center">CONSTANT_NameAndType_info</td>
          <td style="text-align: center">12</td>
          <td style="text-align: center">字段或方法的部分符号引用</td>
      </tr>
  </tbody>
</table></div>
<p>实际上这些东西，虽然我们不知道符号引用是什么东西，我们可以观察出来，这些东西或多或少都是存放类中一些名称、数据之类的东西。</p>
<p>比如我们来看第一个 CONSTANT_Methodref_info 表中存放了什么数据，这里我只列出它的结构表（详细的结构表可以查阅《深入理解Java虚拟机 第三版》中222页总表）</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: center">常量</th>
          <th style="text-align: center">项目</th>
          <th style="text-align: center">类型</th>
          <th style="text-align: center">描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">CONSTANT_Methodref_info</td>
          <td style="text-align: center">tag</td>
          <td style="text-align: center">u1</td>
          <td style="text-align: center">值为10</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">index</td>
          <td style="text-align: center">u2</td>
          <td style="text-align: center">指向声明方法的类描述父 CONSTANT_Class_info 索引项</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">index</td>
          <td style="text-align: center">u2</td>
          <td style="text-align: center">指向名称及类型描述符 CONSTANT_NameAndType_info 索引项</td>
      </tr>
  </tbody>
</table></div>
<p>比如我们刚刚的例子中：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172018359.png"
	width="1079"
	height="114"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172018359_hu7943914770078363039.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172018359_hu8900498141581182656.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="946"
		data-flex-basis="2271px"
	
></p>
<p>可以看到，第一个索引项指向了第3号常量，我们来看看三号常量：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172104765.png"
	width="1082"
	height="73"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172104765_hu15593735302447121801.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172104765_hu13973683447368262795.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1482"
		data-flex-basis="3557px"
	
></p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: center">常量</th>
          <th style="text-align: center">项目</th>
          <th style="text-align: center">类型</th>
          <th style="text-align: center">描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">CONSTANT_Class_info</td>
          <td style="text-align: center">tag</td>
          <td style="text-align: center">u1</td>
          <td style="text-align: center">值为7</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center">index</td>
          <td style="text-align: center">u2</td>
          <td style="text-align: center">指向全限定名常量项的索引</td>
      </tr>
  </tbody>
</table></div>
<p>一直向下推即可</p>
<hr>
<p>可以看到，方法名称为 &ldquo;<init>&quot;，一般构造方法的名称都是 <init>，普通方法名称是什么就是什么，方法描述符为&rdquo;()V&quot;，表示此方法没有任何参数，并且返回值类型为 void，描述符对照表如下：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172623952.png"
	width="1080"
	height="216"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172623952_hu8517796114833669178.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926172623952_hu17337120753337292401.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="500"
		data-flex-basis="1200px"
	
></p>
<p>比如这里有一个方法 <code>public int test(double a，char b ){...}</code>，那么它的描述符就应该是:<code>(DC)I</code>，参数依次放入括号中，括号右边是返回值类型。再比如 <code>public String test(0bject obj){...}</code>，那么它的描述符就应该是：<code>(Ljava/lang/0bject;)Ljava/lang/string</code>，注意如果参数是对象类型，那么必须在后面添加;</p>
<p>对于数组类型，只需要在类型最前面加上 [ 即可，有几个维度，就加几个，比如 <code>public void test(int\[\]\[\] arr)</code>，参数是一个二维 int 类型数组，那么它的描述符为：<code>([[I)V</code></p>
<p>所以，这里表示的，实际上就是此方法是一个无参构造方法，并且是属于 Object 类的。那么，为什么这里需要 Object 类构造方法的符号引用呢？每个类都是直接或简介继承自 0biect 类，所有类的构造方法，必须先调用父类的构造方法，但是如果父类存在无参构造，默认可以不用显示调用 super 关键字（当然本质上是调用了的）</p>
<p>我们可以在反编译结果中的方法中看到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">public org.example.Main<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    descriptor: <span class="o">()</span>V
</span></span><span class="line"><span class="cl">    flags: ACC_PUBLIC
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">      <span class="nv">stack</span><span class="o">=</span>1, <span class="nv">locals</span><span class="o">=</span>1, <span class="nv">args_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">         0: aload_0
</span></span><span class="line"><span class="cl">         1: invokespecial <span class="c1">#1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">         4: <span class="k">return</span>
</span></span><span class="line"><span class="cl">      LineNumberTable:
</span></span><span class="line"><span class="cl">        line 3: <span class="m">0</span>
</span></span><span class="line"><span class="cl">      LocalVariableTable:
</span></span><span class="line"><span class="cl">        Start  Length  Slot  Name   Signature
</span></span><span class="line"><span class="cl">            <span class="m">0</span>       <span class="m">5</span>     <span class="m">0</span>  this   Lorg/example/Main<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 invokespecial （调用父类构造方法）指令的参数指向了 1 号常量，而 1 号常量正是代表的 Object 类的无参构造方法，虽然饶了这么大一圈，但是过程理清楚，还是很简单的。</p>
<p>虽然我们可以直接查看 16 进制的结果，但是还是不够方便，但是我们也不能每次都去使用  javap 命令，所以我们这里安装一个 IDEA 插件，来方便我们查看字节码中的信息，名称为<code>jclasslib Bytecode Viewer</code> :</p>
<p>首先在项目中选中我们的 Main 类，然后点击工具栏的视图，然后点击 show Bytecode With Jcasslib，这样右侧就会出现当前类的字节码解析信息了。注意如果修改了类的话，那么需要你点击运行或是构建，然后点击刷新按钮来进行更新。</p>
<p>接着我们来看下一个内容，在常量池之后，紧接着就是访问标志，访问标志就是类的种类以及类上添加的一些关键字等内容：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926212844736.png"
	width="1081"
	height="351"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926212844736_hu5689664106887216747.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926212844736_hu13130850183129162198.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="307"
		data-flex-basis="739px"
	
></p>
<p>可以看到它只占了 2 个字节，那么它是如何表示访问标志呢？</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926212912484.png"
	width="1082"
	height="439"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926212912484_hu13165774160502685378.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926212912484_hu16061630633301651166.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="246"
		data-flex-basis="591px"
	
></p>
<p>比如我们这里的 Main 类，它是一个普通的 class 类型，并且访问权限为 public，那么它的访问标志值是这样计算的：</p>
<p>ACC PUBLIC | ACC SUPER =  0x0001 | 0x0020 = 0x0021 （这里进行的是按位或运算），可以看到和我们上面的结果是一致的。</p>
<p>再往下就是类索引、父类索引、接口索引：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213124623.png"
	width="1086"
	height="86"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213124623_hu325850301642262325.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213124623_hu16709688167771713066.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1262"
		data-flex-basis="3030px"
	
></p>
<p>可以看到它们的值也是指向常量池中的值，其中 2 号常量正是存储的当前类信息，3 号常量存储的是父类信息，这里就不再倒推回去了，由于没有接口，所以这里接口数量为 0，如果不为 0 还会有一个索引表来引用接口。</p>
<p>接着就是字段和方法表集合了：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213442771.png"
	width="1077"
	height="106"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213442771_hu7716787752708754504.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213442771_hu6878135951952739892.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1016"
		data-flex-basis="2438px"
	
></p>
<p>由于我们这里没有声明任何字段，所以我们先给 Main 类添加一个字段再重新加载一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213844079.png"
	width="1078"
	height="149"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213844079_hu11940873485812111960.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213844079_hu18187338684160677798.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="723"
		data-flex-basis="1736px"
	
></p>
<p>现在字节码就新增了一个字段表，这个字段表实际上就是我们刚刚添加的成员字段 a 的数据。</p>
<p>可以看到一共有四个 2 字节的数据：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213920828.png"
	width="1081"
	height="160"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213920828_hu8997698196122151137.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213920828_hu17566941408911707539.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="675"
		data-flex-basis="1621px"
	
></p>
<p>首先是 access_flags，这个与上面类标志的计算规则是一样的，表还是先列出来吧</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213945628.png"
	width="1085"
	height="373"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213945628_hu4202569263670670871.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926213945628_hu14971401034226639774.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="290"
		data-flex-basis="698px"
	
></p>
<p>后续字节码可以自己对应去看对应关系，不在此赘述</p>
<h4 id="字节码指令">字节码指令
</h4><p>虚拟机的指令是由一个字节长度的、代表某种特定操作含义的数字（操作码，类似于机器语言），操作后面也可以携带 0个或多个参数一起执行。我们前面已经介绍过了，JVM 实际上并不是面向寄存器架构的，而是面向操作数栈，所以大多数指令都是不带参数的。</p>
<p>由于之前已经讲解过大致运行流程，这里我们就以当前的 Main 类中的 main 方法作为教材进行讲解：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，main 方法中首先是定义了一个 int 类型的变量 i，并赋值为10，然后变量 a 接收  i++ 的值，变量 b 接收 ++i 的值，那么我们来看看编译成字节码之后，是什么样的：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926214537336.png"
	width="294"
	height="260"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926214537336_hu17277305237625987440.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926214537336_hu16482718484361007250.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="113"
		data-flex-basis="271px"
	
></p>
<ul>
<li>
<p>首先第一句， bipush，将 10 送至操作数顶。</p>
</li>
<li>
<p>接下来将操作数栈顶的数值存进1号本地变量，也就是变量 i 中。</p>
</li>
<li>
<p>接着将变量 i 中的值又丢向操作数栈顶</p>
</li>
<li>
<p>这里使用 iinc 指令，将1号本地变量的值增加 1（结束之后i的值就是11了）</p>
</li>
<li>
<p>接着将操作数栈顶的值(操作数栈顶的值是10)存入2号本地变量(这下彻底知道i++到底干了啥才会先返回后自增了吧，从原理角度来说，实际上 i 是先自增了的，但由于这里取的是（操作数栈中的值，所以说就得到了 i 之前的值）</p>
</li>
<li>
<p>接着往下，我们看到 ++i 是先直接将 i 的值自增 1</p>
</li>
<li>
<p>然后在将其值推向操作数栈顶</p>
</li>
</ul>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926214830988.png"
	width="1083"
	height="138"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926214830988_hu14260753790595647105.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926214830988_hu7905905588593901827.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="784"
		data-flex-basis="1883px"
	
></p>
<p>而从结果来看， i++ 操作确实是先返回再自增的，而字节码指令层面来说，却是截然相反的，只是结果一致罢了。</p>
<h4 id="asm-字节码编程">ASM 字节码编程
</h4><p>既然字节码文件结构如此清晰，那么我们能否通过编程，来直接创建一个字节码文件呢？如果我们可以直接编写一个字节码文件，那么我们就可以省去编译的过程。ASM（某些 JDK 中内置）框架正是用于支持字节码编程的框架。</p>
<p>比如现在我们需要创建一个普通的 Main 类（暂时不写任何内容）</p>
<p>首先我们来看看如何通过编程创建一个 Main 类的字节码文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_MAXS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>首先需要获取 Classwriter 对象，我们可以使用它来编辑类的字节码文件，在构造时需要传入参数：</p>
<ul>
<li>
<p>0 这种方式不会自动计算操作数栈和局部临时变量表大小，需要自己手动来指定</p>
</li>
<li>
<p>ClassWriter.COMPUTE_MAXS(1) 这种方式会自动计算上述操作数栈和局部临时变量表大小，但需要手动触发</p>
</li>
<li>
<p>ClassWriter.COMPUTE_FRAMES(2) 这种方式不仅会计算上述操作数栈和局部临时变量表大小，而且会自动计算StackMapFrames</p>
</li>
</ul>
<p>这里我们使用 ClassWriter.COMPUTE_MAXS 即可</p>
<p>接着我们首先需要指定类的一些基本信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_MAXS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">writer</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="n">V1_8</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="s">&#34;org/example/Main&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s">&#34;java/lang/Object&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们将字节码文件的版本设定位 Java8，然后修饰符设定为 ACC_PUBLIC 代表 public class Main，类名称注意要携带包名，标签设置为 null，父类设定为 Object 类，然后没有实现任何接口，所以说最后一个参数也是 null。</p>
<p>接着，一个简单的类字节码文件就创建好了，我们可以尝试将其进行保存:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_MAXS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writer</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="n">V1_8</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="s">&#34;org/example/Main&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s">&#34;java/lang/Object&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;./Main.class&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">writer</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220135372.png"
	width="611"
	height="245"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220135372_hu16034635874094519990.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220135372_hu12195584021144949299.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="249"
		data-flex-basis="598px"
	
></p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220210318.png"
	width="670"
	height="386"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220210318_hu11162738275798567608.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220210318_hu9738854412813562808.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="173"
		data-flex-basis="416px"
	
></p>
<p>我们知道，正常的类在编译之后，如果没有手动添加构造方法，那么会自带一个无参构造，但是我们这个类中还没有，所以我们来手动添加一个无参构造方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">writer</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;()V&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220357387.png"
	width="590"
	height="330"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220357387_hu3662652314989448685.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220357387_hu12218414886860779338.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="178"
		data-flex-basis="429px"
	
></p>
<p>可以看到反编译的结果中已经存在了我们的构造方法</p>
<p>但是这样是不合法的，因为我们的构造方法还没有添加父类构造方法调用，所以说我们还需要在方法中添加父类构造方法调用指令：</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220534030.png"
	width="959"
	height="384"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220534030_hu4595620679605444398.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926220534030_hu9085107107771841661.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="249"
		data-flex-basis="599px"
	
></p>
<p>我们需要对方法进行详细编辑：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_MAXS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writer</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="n">V1_8</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="s">&#34;org/example/Main&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s">&#34;java/lang/Object&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 通过 MethodVisitor 接收返回值，进行进一步操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MethodVisitor</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span><span class="s">&#34;()V&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 开始编辑代码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Label 用于存储行号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 当前代码写到哪行了，l1 得到的就是多少行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加源码行数对应表（其实可以不用）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLineNumber</span><span class="p">(</span><span class="n">11</span><span class="p">,</span><span class="w"> </span><span class="n">l1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 注意不同类型的指令需要用不同的方法来调用，因为操作数不一致，具体的注释有写</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">ALOAD</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitMethodInsn</span><span class="p">(</span><span class="n">INVOKESPECIAL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;java/lang/Object&#34;</span><span class="p">,</span><span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span><span class="s">&#34;()V&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加本地变量表，这里加的是 this 关键字，但是方法中没用到，其实可以不加</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLocalVariable</span><span class="p">(</span><span class="s">&#34;this&#34;</span><span class="p">,</span><span class="s">&#34;Lorg/example/Main;&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 最后设定最大栈深度和本地变量数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitMaxs</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitEnd</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;./Main.class&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">writer</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">Classfile /D:/code/blogchat-java/untitled/Main.class
</span></span><span class="line"><span class="cl">  Last modified 2024-9-26<span class="p">;</span> size <span class="m">227</span> bytes
</span></span><span class="line"><span class="cl">  MD5 checksum 39fa40f1948f91acc569c91eac8615d3     
</span></span><span class="line"><span class="cl">public class org.example.Main
</span></span><span class="line"><span class="cl">  minor version: <span class="m">0</span>
</span></span><span class="line"><span class="cl">  major version: <span class="m">52</span>
</span></span><span class="line"><span class="cl">  flags: ACC_PUBLIC
</span></span><span class="line"><span class="cl">Constant pool:
</span></span><span class="line"><span class="cl">   <span class="c1">#1 = Utf8               org/example/Main</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#2 = Class              #1             // org/example/Main</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#3 = Utf8               java/lang/Object</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#4 = Class              #3             // java/lang/Object</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#5 = Utf8               &lt;init&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#6 = Utf8               ()V</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#7 = NameAndType        #5:#6          // &#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#8 = Methodref          #4.#7          // java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">   <span class="c1">#9 = Utf8               this</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#10 = Utf8               Lorg/example/Main;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#11 = Utf8               Code</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#12 = Utf8               LocalVariableTable</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#13 = Utf8               LineNumberTable</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  public org.example.Main<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    descriptor: <span class="o">()</span>V
</span></span><span class="line"><span class="cl">    flags: ACC_PUBLIC
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">      <span class="nv">stack</span><span class="o">=</span>1, <span class="nv">locals</span><span class="o">=</span>1, <span class="nv">args_size</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">         0: aload_0
</span></span><span class="line"><span class="cl">         1: invokespecial <span class="c1">#8                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V</span>
</span></span><span class="line"><span class="cl">      LocalVariableTable:
</span></span><span class="line"><span class="cl">        Start  Length  Slot  Name   Signature
</span></span><span class="line"><span class="cl">            <span class="m">0</span>       <span class="m">0</span>     <span class="m">0</span>  this   Lorg/example/Main<span class="p">;</span>
</span></span><span class="line"><span class="cl">      LineNumberTable:
</span></span><span class="line"><span class="cl">        line 11: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到和之前的基本一致了，到此为止我们构造方法就编写完成了，接着我们来写一下 main 方法，一会我们就可以通过main 方法来运行Java程序了。比如我们要编写这样一个程序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>看起来很简单的一个程序对吧，但是我们如果手动去组装指令，会极其麻烦！首先 main 方法是一个静态方法，并且方法是 public 权限，然后还有一个参数 String[] args ，所以说我们这里要写的内容有点小多：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassWriter</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassWriter</span><span class="p">(</span><span class="n">ClassWriter</span><span class="p">.</span><span class="na">COMPUTE_MAXS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">writer</span><span class="p">.</span><span class="na">visit</span><span class="p">(</span><span class="n">V1_8</span><span class="p">,</span><span class="w"> </span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="s">&#34;org/example/Main&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s">&#34;java/lang/Object&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 通过 MethodVisitor 接收返回值，进行进一步操作</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MethodVisitor</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">ACC_PUBLIC</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span><span class="s">&#34;()V&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 开始编辑代码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Label 用于存储行号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 当前代码写到哪行了，l1 得到的就是多少行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加源码行数对应表（其实可以不用）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLineNumber</span><span class="p">(</span><span class="n">11</span><span class="p">,</span><span class="w"> </span><span class="n">l1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 注意不同类型的指令需要用不同的方法来调用，因为操作数不一致，具体的注释有写</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">ALOAD</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitMethodInsn</span><span class="p">(</span><span class="n">INVOKESPECIAL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;java/lang/Object&#34;</span><span class="p">,</span><span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span><span class="s">&#34;()V&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitInsn</span><span class="p">(</span><span class="n">RETURN</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 添加本地变量表，这里加的是 this 关键字，但是方法中没用到，其实可以不加</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitLocalVariable</span><span class="p">(</span><span class="s">&#34;this&#34;</span><span class="p">,</span><span class="s">&#34;Lorg/example/Main;&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 最后设定最大栈深度和本地变量数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitMaxs</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">visitor</span><span class="p">.</span><span class="na">visitEnd</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 开始安排 main 方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MethodVisitor</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="na">visitMethod</span><span class="p">(</span><span class="n">ACC_PUBLIC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ACC_STATIC</span><span class="p">,</span><span class="s">&#34;main&#34;</span><span class="p">,</span><span class="s">&#34;([Ljava/lang/String;)V&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 记录起始行信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLineNumber</span><span class="p">(</span><span class="n">13</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 首先是 int a = 10 的操作，执行指令以此为：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// bipush 10 将10推向操作数栈顶</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// istore_1 将操作数栈顶元素保存到 1 号本地变量 a 中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitIntInsn</span><span class="p">(</span><span class="n">BIPUSH</span><span class="p">,</span><span class="w"> </span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">ISTORE</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 记录行信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLineNumber</span><span class="p">(</span><span class="n">14</span><span class="p">,</span><span class="n">l4</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 获取 System 类中 out 静态变量 （PrintStream 接口），用于打印</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitFieldInsn</span><span class="p">(</span><span class="n">GETSTATIC</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;java/lang/System&#34;</span><span class="p">,</span><span class="s">&#34;out&#34;</span><span class="p">,</span><span class="s">&#34;Ljava/io/PrintStream;&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 把 a 取出来</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitVarInsn</span><span class="p">(</span><span class="n">ILOAD</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 调用接口中的抽象方法 println</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitMethodInsn</span><span class="p">(</span><span class="n">INVOKEVIRTUAL</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;java/io/PrintStream&#34;</span><span class="p">,</span><span class="s">&#34;println&#34;</span><span class="p">,</span><span class="s">&#34;(I)V&#34;</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 再次记录行信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l6</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLineNumber</span><span class="p">(</span><span class="n">15</span><span class="p">,</span><span class="n">l6</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitInsn</span><span class="p">(</span><span class="n">RETURN</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Label</span><span class="w"> </span><span class="n">l7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Label</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLabel</span><span class="p">(</span><span class="n">l7</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 最后是本地变量表中的各个变量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLocalVariable</span><span class="p">(</span><span class="s">&#34;args&#34;</span><span class="p">,</span><span class="s">&#34;[Ljava/lang/String;&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l7</span><span class="p">,</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitLocalVariable</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">,</span><span class="s">&#34;I&#34;</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="n">l4</span><span class="p">,</span><span class="n">l7</span><span class="p">,</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitMaxs</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v2</span><span class="p">.</span><span class="na">visitEnd</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="s">&#34;./Main.class&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stream</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">writer</span><span class="p">.</span><span class="na">toByteArray</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926224857973.png"
	width="739"
	height="445"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926224857973_hu1588401717214766424.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926224857973_hu16767139632574163962.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="166"
		data-flex-basis="398px"
	
></p>
<p>Spring 中的动态代理就是使用了 此 ASM 字节码框架</p>
<h3 id="类加载机制">类加载机制
</h3><p>现在，我们已经了解了字节码文件的结构，以及 JVM 如何对内存进行管理，现在只剩下最后一个谜团等待解开了，也就是我们的类字节码文件到底是如何加载到内存中的，加载之后又会做什么事情。</p>
<h4 id="类加载过程">类加载过程
</h4><p>首先，要加载一个类，一定是出于某种目的的，比如我们要运行我们的 Java 程序，那么就必须要加载主类才能运行主类中的主方法，又或是我们需要加载数据库驱动，那么可以通过反射来将对应的数据库驱动类进行加载。</p>
<p>所以，一般在这些情况下，如果类没有被加载，那么会被自动加载：</p>
<ul>
<li>
<p>使用 new 关键字创建对象时</p>
</li>
<li>
<p>使用某个类的静态成员（包括方法和字段）的时候（当然，final类型的静态字段有可能在编译的时候被放到了当前类的常量池中，这种情况下是不会触发自动加载的）</p>
</li>
<li>
<p>使用反射对类信息进行获取的时候（之前的数据库驱动就是这样的）加载一个类的子类时</p>
</li>
<li>
<p>加载接口的实现类，且接口带有 default 的方法默认实现时</p>
</li>
</ul>
<p>比如这种情况，那么需要用到另一个类中的成员字段，所以就必须将另一个类加载之后才能访问：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Test</span><span class="p">.</span><span class="na">str</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;初始化&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;啊啊啊&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里我们就演示一个不太好理解的情况，我们现在将静态成员变量修改为 final 类型的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Main</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Test</span><span class="p">.</span><span class="na">str</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">static</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;初始化&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;啊啊啊&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，在主方法中，我们使用了 Test 类的静态成员变量，并且此静态成员变量是一个 final 类型的，也就是说不可能再发生改变。Test 类会像上面一样被初始化吗？</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926225905158.png"
	width="302"
	height="77"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926225905158_hu8149947828390866298.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926225905158_hu13427570897415950458.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="392"
		data-flex-basis="941px"
	
></p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926225942392.png"
	width="713"
	height="183"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926225942392_hu10932066478184692126.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926225942392_hu13942795991009622926.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="389"
		data-flex-basis="935px"
	
></p>
<p>ldc 从常量池里取值</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230016978.png"
	width="606"
	height="556"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230016978_hu7146711947183653745.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230016978_hu1618404595760994991.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="261px"
	
></p>
<p>很明显，这里使用的是 ldc 指令从常量池中将字符串取出并推向操作数栈顶，也就是说，在编译阶段，整个 Test.str 直接被替换为了对应的字符串（因为 final 不可能发生改变的，编译就会进行优化，直接来个字符串比你去加载类在获取快得多不是吗，反正结果都一样），所以说编译之后，实际上跟 Test 类半毛钱关系都没有了。</p>
<p>所以说，当你在某些情况下疑惑为什么类加载了或是没有加载时，可以从字节码指令的角度去进行分析，一般情况下，只要遇到 new、getstatic、putstatic、invokestatic这些指令时，都会进行类加载，比如:</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230211431.png"
	width="1084"
	height="269"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230211431_hu15348733647213625231.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230211431_hu321063111732607768.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="402"
		data-flex-basis="967px"
	
></p>
<p>好了，聊完了类的加载触发条件，我们接着来看一下类的详细加载流程</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230235557.png"
	width="1065"
	height="535"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230235557_hu17322339707590573632.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926230235557_hu2495694587760140171.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="199"
		data-flex-basis="477px"
	
></p>
<p>首先类的生命周期一共有 7 个阶段，而首当其冲的就是加载，加载阶段需要获取此类的二进制数据流，比如我们要从硬盘中读取一个 clas s文件，那么就可以通过文件输入流来获取类文件的 byte[] ，也可以是其他各种途径获取类文件的输入流，甚至网络传输并加载个类也不是不可以。然后交给类加载器进行加载（类加载器可以是 JDK 内置的，也可以是开发者自己撸的，后面会详细介绍）类的所有信息会被加载到方法区中，并且在堆内存中会生成一个代表当前类的 Class 类对象（那么思考一下，同一个 Class 文件加载的类，是唯一存在的吗？），我们可以通过此对象以及反射机制来访问这个类的各种信息。</p>
<p>数组类要稍微特殊一点，通过前面的检验，我们发现数组在创建后是不会导致类加载的，数组类型本身不会通过类加载器进行加载的，不过你既然要往里面丢对象进去，那最终依然是要加载类的。</p>
<p>接着我们来看验证阶段，验证阶段相当于是对加载的类进行一次规范校验（因为一个类并不一定是由我们使用 IDEA 编译出来的，有可能是像我们之前那样直接用 ASM 框架写的一个），如果说类的任何地方不符合虚拟机规范，那么这个类是不会验证通过的，如果没有验证机制，那么一旦出现危害虚拟机的操作，整个程序会出现无法预料的后果。</p>
<p>验证阶段，首先是文件格式的验证：</p>
<ul>
<li>是否魔数是否是 咖啡北鼻</li>
<li>主、次版本号是否可以由当前虚拟机运行</li>
<li>Class 文件各个部分完整性</li>
<li>&hellip;</li>
</ul>
<p>有关类验证的详细过程，可以参考《深入理解Java虚拟机 第三版》268页。</p>
<p>接下来就是准备阶段了，这个阶段会为类变量分配内存，并为一些字段设定初始值，注意是系统规定的初始值，不是我们手动指定的初始值。</p>
<p>再往下就是解析阶段，此阶段是将常量池内的符号引用替换为直接引用的过程，也就是说，到这个时候，所有引用变量的指向都是已经切切实实地指向了内存中的对象了。</p>
<p>再往下就是解析阶段，此阶段是将常量池内的符号引用替换为直接引用的过程，也就是说，到这个时候，所有引用变量的指向都是已经切切实实地指向了内存中的对象了。</p>
<p>到这里，链接过程就结束了，也就是说这个时候类基本上已经完成大部分内容的初始化了</p>
<p>最后就是真正的初始化阶段了，从这里开始，类中的 Java 代码部分，才会开始执行，还记得我们之前介绍的 <clinit> 方法吗，它就是在这个时候执行的，比如我们的类中存在一个静态成员变量，并且赋值为 10，或是存在一个静态代码块，那么就会自动生成一个 <clinit> 方法来进行赋值操作，但是这个方法是自动生成的。</p>
<p>全部完成之后，我们的类就算是加载完成了</p>
<h3 id="类加载器">类加载器
</h3><p>Java 提供了类加载器，以便我们自己可以更好地控制类加载，我们可以自定义类加载器，也可以使用官方自带的类加载器去加载类。对于任意一个类，都必须由加载它的类加载器和这个类本身一起共同确立其在 Java 虚拟机中的唯一性。</p>
<p>也就是说，一个类可以由不同的类加载器加载，并且，不同的类加载器加载的出来的类，即使来自同一个 Class 文件，也是不同的，只有两个类来自同一个 Class 文件并且是由同一个类加载器加载的，才能判断为是同一个。默认情况下，所有的类都是由 JDK 自带的类加载器进行加载。</p>
<p>实际上，JDK 内部提供的类加载器一共有三个，比如上面我们的 Main 类，其实是被 AppClassLoader 加载的，而JDK内部的类，都是由 BootstrapClassLoader 加载的，这其实就是为了实现双亲委派机制而坐的。</p>
<p><img src="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926231415750.png"
	width="1070"
	height="990"
	srcset="/p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926231415750_hu1406866117907087286.png 480w, /p/jvm-%E8%AF%A6%E8%A7%A3/image-20240926231415750_hu14071863225968570036.png 1024w"
	loading="lazy"
	
		alt="双亲委派"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="259px"
	
></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E7%A7%8B%E6%8B%9B/">秋招</a>
        
            <a href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E9%9D%A2%E8%AF%95%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/">
        
        
            <div class="article-image">
                <img src="/p/%E9%9D%A2%E8%AF%95%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/zoe.bb8aea0134d63057a4bf2ae4661aec35_hu954729557089800669.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 面试刷题记录"
                        
                        data-hash="md5-u4rqATTWMFekvyrkZhrsNQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">面试刷题记录</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
        
        
            <div class="article-image">
                <img src="/p/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/zoye.2d07a3cb4c272d2496b9fefc47d77130_hu10520129471486598378.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 设计模式"
                        
                        data-hash="md5-LQejy0wnLSSWuf78R9dxMA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">设计模式</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 AKAxedx
    </section>
    
    <section class="powerby">
        
            知识学爆，鸿运齐天 <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
